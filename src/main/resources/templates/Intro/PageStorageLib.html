<div xmlns:th="http://www.thymeleaf.org" th:fragment="content">
    <div class="text-center space-y-6">
        <h1 class="text-4xl font-bold text-blue-600">ğŸ‡ BurrowNest</h1>
        <p class="text-lg text-gray-700">í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬</p>
        <p class="text-sm text-gray-500">BurrowNestë¥¼ ìœ„í•´ì„  ì•„ë˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>
        <p class="text-sm text-gray-500">1. ffmpeg :> sudo apt install -y ffmpeg</p>
        <p class="text-sm text-gray-500">6. exiftool :> sudo apt install -y exiftool </p>
        <button type="button" id="applyBtn" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition" th:onclick="apply()">ì§„í–‰</button>
    </div>
    
    <script th:inline="javascript">
	    
	    const eleMessage = document.getElementById("message");
	    const eleProgressText = document.getElementById("progressText");
	    const eleProgressBar = document.getElementById("progressBar");
	    const eleProgressPercent = document.getElementById("progressPercent");
	    const eleStatus = document.getElementById("status");
	
	    // 4. ì €ì¥ ìƒíƒœê°€ ì „ë‹¬ë¨.
	    function updateProgress(receiveData) {
	    	
	    	console.log("User ì†Œì¼“ ë°ì´í„° ìˆ˜ì‹  " + receiveData.body);
	    	const json = JSON.parse(receiveData.body);
	    	
	    	if( Boolean(json.done) ){
	    		// ì‘ì—… ì™„ë£Œ.
	    		eleStatus.textContent = "âœ… ì™„ë£Œ";
	    		
	    		socketScript.disconnect();
	    		// 5. ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™
	    		nextPage('PageStorageLoad', 'PageComplete');
	    		return;
	    	}

	    	const total = Number(json.total);
	    	const progress = Number(json.progress);
	    	const message  = json.message;
	    	
	    	const percent = total > 0 ? Math.floor((progress / total) * 100) : 0;
	    	
	    	eleMessage.textContent = message || "";
	    	eleProgressText.textContent = `${progress} / ${total}`;
	    	eleProgressBar.style.width = `${percent}%`;
	    	eleProgressPercent.textContent = `${percent}%`;
	    }
	    
	    let socketScript = null;
	    
	    function apply(){
	    	
	    	buttonStatus( "applyBtn", false);
	    	
	    	// 1. ì›¹ ì†Œì¼“ ì ‘ì†.
	    	const wsUrl = /*[[@{/BackEvent}]]*/ null;
	    	const connectionInfo = new ConnectionInfo(wsUrl, { service: 'Burrow' });
	    	
	    	connectionInfo.setOpenHandler((frame) => {
	    		
	    		// 2. ì ‘ì† ì„±ê³µ í•˜ë©´ user-name íšë“
	    		const currentUserKey = frame.headers['user-name'];
	    		console.log("ì—°ê²°ë¨", currentUserKey );
	    		
	    		SaveInit( currentUserKey );
	    	});
	    	
	    	connectionInfo.setCloseHandler(() => {
	    		console.log("ì—°ê²° í•´ì œ");
	    	});

	    	socketScript = new SocketScript(connectionInfo);
	    	
	    	socketScript.addReceiveInfo(new ReceiveInfo('/user/toFront/RecieveStatus', updateProgress));
	    	// socketScript.addReceiveInfo(new ReceiveInfo('/toFront/RecieveStatus', publicCallBackStatus));
	    	
	    	socketScript.connect();
	    }
	    
	    
	    // 3. saveInit í˜¸ì¶œ
    	async function SaveInit(wsUser){
    		
    		const encrypt = new JSEncrypt();
            encrypt.setPublicKey(/*[[${unique.publicKey}]]*/ null);

            const encPw = encrypt.encrypt( document.getElementById("pwd1").value );	
    	
            const storageList = getStorageListValues();
            
    		const requestData = {
    		        token: /*[[${unique.token}]]*/ null,
    		        rsaId: /*[[${unique.rsaId}]]*/ null,
    		        pw: encPw,
    		        wsUserName: wsUser,
    		        roots: storageList
    		    };
    		
    		try {
    	        const res = await fetch(/*[[@{/Intro/SaveInit.json}]]*/ null, {
    	            method: 'POST',
    	            headers: { "Content-Type": "application/json" },
    	            credentials: 'include',
    	            body: JSON.stringify(requestData)
    	        });
    	        
    	        console.info('âœ… response', res);

    	        if (res.ok) {
    	        	console.info('ì‘ì—… ì§„í–‰ ì¤‘');
    	        }
    	        return true;
    	    } catch (err) {
    	        console.error("refreshToken ì‹¤íŒ¨:", err);
    	        buttonStatus( "applyBtn", true);
    	        return false;
    	    }
    	}
    </script>
</div>
