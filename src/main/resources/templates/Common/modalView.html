
<div xmlns:th="http://www.thymeleaf.org"
	th:fragment="modalView" >

<!-- íŒì—…ì„ ìœ„í•œ ì»¨í…Œì´ë„ˆ -->
<div id="popupContainer" >
    <div id="popupOverlay" class="fixed inset-0 z-45 bg-black bg-opacity-50 hidden flex justify-center items-center">
        <div id="popupWindow" class="modalTop bg-white rounded-lg shadow-lg relative">
            <div id="popupContentContainer">
                <!-- ì„œë²„ì—ì„œ ë¡œë“œëœ ë‚´ìš©ì´ ì—¬ê¸°ì— ì‚½ìž…ë¨ -->
            </div>
        </div>
    </div>
</div>
<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ ì¶”ê°€ (popupContainer ë°”ê¹¥ or ì•ˆìª½ ì–´ë””ë“  ìƒê´€ì—†ìŒ) -->
<div id="loadingOverlay" class="fixed inset-0 z-50 bg-black bg-opacity-40 hidden flex items-center justify-center">
  <div class="text-white text-xl font-semibold animate-pulse">ë¡œë”© ì¤‘...</div>
</div>


<script>
    let popupIndex = 0; // ì¤‘ì²© ëª¨ë‹¬ì„ ìœ„í•œ ê³ ìœ  ID
    
	// Method ì¢…ë¥˜
	const MethodType = Object.freeze({
		Get: "GET",
		Post: "POST"
	});

	// ContentsType ì¢…ë¥˜
	const ContentsType = Object.freeze({
		Form: "x-www-form-urlencoded",
		Json: "application/json",
		Multipart:"multipart/form-data"
	});

    async function openPopup(sendObj) {
    	
    	const defaults = {
   			url: null,
			method: MethodType.Post,
			contentType: ContentsType.Json,
			NotCheck:false,
			data:null,
			popupId:null,
	        width: '800px'
    	}
    	
		const sendValue = { ...defaults, ...sendObj };
    	
    	console.info( 'Modal open req : ', JSON.stringify(sendValue) ); 

    	if( ! sendValue.url ){
    		console.warn("âŒ [openPopup Error] 'url' ê°’ì´ í•„ìˆ˜ìž…ë‹ˆë‹¤.");
			throw new Error("âŒ [openPopup Error] 'url' ê°’ì´ í•„ìˆ˜ìž…ë‹ˆë‹¤.");
		}
    	
    	if( ! sendValue.popupId ){
    		console.warn("âŒ [openPopup Error] 'popupId' ê°’ì´ í•„ìˆ˜ìž…ë‹ˆë‹¤.");
			throw new Error("âŒ [openPopup Error] 'popupId' ê°’ì´ í•„ìˆ˜ìž…ë‹ˆë‹¤.");
		}

    	if( ! sendValue.NotCheck ){
    		console.info( 'Modal open Refresh Check ' );
        	const refresh = await checkAndRefreshToken();
        	if( ! refresh ){
        		console.warn('âŒ [authCheck Error] ì¸ì¦ í•„ìš”.');
        		//throw new Error("âŒ [authCheck Error] ì¸ì¦ í•„ìš”.");
        		return;
        	}
    	}
		
    	
    	// âœ… ë¡œë”© í™”ë©´ ë³´ì´ê¸°
        const loading = document.getElementById("loadingOverlay");
        if (loading) loading.classList.remove("hidden");
        
		const width = sendValue.width;
		
        // ë°ì´í„° ë¡œë“œ
        apiRequest(sendValue.url, {
	            method: sendValue.method,
	            headers: { "Content-Type": sendValue.contentType },
	            body: sendValue.data
	    	})
        	.then(response => {
        		if (!response.ok) {
        			// HTTP ìƒíƒœ ì½”ë“œê°€ 200ì´ ì•„ë‹ˆë©´ ì˜ˆì™¸ ë°œìƒ
        			throw new Error(`HTTP ì˜¤ë¥˜ ë°œìƒ: ${response.status} ${response.statusText}`);
        		}
        		return response.text(); // ì •ìƒì ì¸ ê²½ìš° HTML ë°˜í™˜
        	})
        	.then(html => {
        		
        		popupIndex++; // ìƒˆë¡œìš´ íŒì—… ID ì¦ê°€

                // ê¸°ì¡´ íŒì—… ì»¨í…Œì´ë„ˆ ë³µì œ
                const originalPopup = document.getElementById("popupOverlay");
                const newPopup = originalPopup.cloneNode(true);

                // ìƒˆë¡œìš´ íŒì—… ID ë³€ê²½
                const newPopupId = `popupOverlay_${popupIndex}`;
                const newWindowId = `popupWindow_${popupIndex}`;
                const newContentId = `popupContentContainer_${popupIndex}`;

                newPopup.id = newPopupId;
                const popupWindow = newPopup.querySelector("#popupWindow");
                popupWindow.id = newWindowId;
                // width ì ìš©
                popupWindow.style.width = width;
                newPopup.querySelector("#popupContentContainer").id = newContentId;

                // ëª¨ë‹¬ ê°œë³„ ë“œëž˜ê·¸ ê°ì²´ ì¶”ê°€
                popupWindow.dragObj = { isDragging: false, offsetX: 0, offsetY: 0 };

                // ìƒˆ íŒì—… ìˆ¨ê¹€ í•´ì œ
                newPopup.classList.remove("hidden");

                // ìƒˆë¡œìš´ íŒì—… ì¶”ê°€
                document.getElementById("popupContainer").appendChild(newPopup);
                
        		const container = document.getElementById(newContentId);
        		container.innerHTML = html;
        		
        		// ìƒˆë¡œ ì¶”ê°€ëœ script íƒœê·¸ ì‹¤í–‰ (Thymeleaf script ì‹¤í–‰)
        		console.info('popupIndex', popupIndex);
        		
           		container.querySelectorAll("script").forEach(oldScript => {
           			const newScript = document.createElement("script");

           		    if (oldScript.src) {
           		        newScript.src = oldScript.src;
           		    } else {
           		        newScript.textContent = oldScript.textContent;
           		    }

           		    // ê¸°ì¡´ script ì†ì„± ë³µì‚¬
           		    [...oldScript.attributes].forEach(attr => {
           		        newScript.setAttribute(attr.name, attr.value);
           		    });

           		    // popupIndex ê¸°ë°˜ ì‹ë³„ìž ì¶”ê°€
           		    newScript.dataset.popupId = `popupOverlay_${popupIndex}`;

           		    oldScript.remove();
           		    document.body.appendChild(newScript);
           		});
        		
        		// âœ… ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê¸°
                if (loading) loading.classList.add("hidden");
        	})
        	.catch(error => {
        		console.error("ì—ëŸ¬ ë°œìƒ:", error)
        		if (loading) loading.classList.add("hidden");
        	});
    }

    // íŒì—… ë‹«ê¸° í•¨ìˆ˜ (í•´ë‹¹ ëª¨ë‹¬ë§Œ ë‹«ê¸°)
    function closePopup(buttonElement) {
	    const modal = buttonElement.closest(".fixed");
	
	    if (! modal) {
	    	return;
	    }
	    
        const modalId = modal.id;
        console.info(`ðŸ”’ ëª¨ë‹¬ ì œê±°: ${modalId}`);

        // âœ… 1. ë‚´ë¶€ ìš”ì†Œ ì´ˆê¸°í™” (ë©”ëª¨ë¦¬ ë¦´ë¦¬ì¦ˆ ìœ ë„)
        modal.querySelectorAll("*").forEach(el => {
            if (el.tagName !== "SCRIPT") {
                el.textContent = '';
                el.innerHTML = '';
            }
        });

        // âœ… 2. ê´€ë ¨ script ì œê±° (data-popup-id or src ê¸°ì¤€)
        const scripts = document.getElementsByTagName('script');
        for (let i = scripts.length - 1; i >= 0; i--) {
            const script = scripts[i];

            // src ê¸°ë°˜ ì œê±°
            if (script.src && script.src.includes(modalId)) {
                console.info(`ðŸ§¹ ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸ ì œê±°: ${script.src}`);
                script.parentNode.removeChild(script);
            }

            // data-popup-id ê¸°ë°˜ ì œê±°
            if (script.dataset && script.dataset.popupId === modalId) {
                console.info(`ðŸ§¹ ì¸ë¼ì¸ ìŠ¤í¬ë¦½íŠ¸ ì œê±°: ${modalId}`);
                script.parentNode.removeChild(script);
            }
        }

        // âœ… 3. ëª¨ë‹¬ DOM ì œê±°
        modal.remove();
	}

    
	// ë“œëž˜ê·¸ ì‹œìž‘ í•¨ìˆ˜ (ê° ëª¨ë‹¬ë³„ dragObj ì‚¬ìš©)
    function startDrag(event, headerElement) {
        const popup = headerElement.closest(".modalTop"); // í˜„ìž¬ ëª¨ë‹¬ ì°¾ê¸°
        if (!popup) return;

        popup.dragObj.isDragging = true;
        popup.dragObj.offsetX = event.clientX - popup.offsetLeft;
        popup.dragObj.offsetY = event.clientY - popup.offsetTop;

        // ê°œë³„ ëª¨ë‹¬ì— ì´ë²¤íŠ¸ ë“±ë¡
        document.addEventListener("mousemove", (e) => doDrag(e, popup));
        document.addEventListener("mouseup", (e) => stopDrag(e, popup));
    }

    // ë“œëž˜ê·¸ ì¤‘ (ê° ëª¨ë‹¬ë³„ dragObj ì°¸ì¡°)
    function doDrag(event, popup) {
        if (!popup.dragObj.isDragging) return;
        popup.style.position = "absolute";
        popup.style.left = event.clientX - popup.dragObj.offsetX + "px";
        popup.style.top = event.clientY - popup.dragObj.offsetY + "px";
    }

    // ë“œëž˜ê·¸ ì¢…ë£Œ (ê° ëª¨ë‹¬ë³„ ì´ë²¤íŠ¸ ì œê±°)
    function stopDrag(event, popup) {
        popup.dragObj.isDragging = false;
        document.removeEventListener("mousemove", (e) => doDrag(e, popup));
        document.removeEventListener("mouseup", (e) => stopDrag(e, popup));
    }
</script>
</div>
