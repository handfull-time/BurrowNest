
<div xmlns:th="http://www.thymeleaf.org"
	th:fragment="modalView" >

<!-- 팝업을 위한 컨테이너 -->
<div id="popupContainer" >
    <div id="popupOverlay" class="fixed inset-0 z-45 bg-black bg-opacity-50 hidden flex justify-center items-center">
        <div id="popupWindow" class="modalTop bg-white rounded-lg shadow-lg relative">
            <div id="popupContentContainer">
                <!-- 서버에서 로드된 내용이 여기에 삽입됨 -->
            </div>
        </div>
    </div>
</div>
<!-- 로딩 오버레이 추가 (popupContainer 바깥 or 안쪽 어디든 상관없음) -->
<div id="loadingOverlay" class="fixed inset-0 z-50 bg-black bg-opacity-40 hidden flex items-center justify-center">
  <div class="text-white text-xl font-semibold animate-pulse">로딩 중...</div>
</div>


<script>
    let popupIndex = 0; // 중첩 모달을 위한 고유 ID
    
	// Method 종류
	const MethodType = Object.freeze({
		Get: "GET",
		Post: "POST"
	});

	// ContentsType 종류
	const ContentsType = Object.freeze({
		Form: "x-www-form-urlencoded",
		Json: "application/json",
		Multipart:"multipart/form-data"
	});

    async function openPopup(sendObj) {
    	
    	const defaults = {
   			url: null,
			method: MethodType.Post,
			contentType: ContentsType.Json,
			NotCheck:false,
			data:null,
			popupId:null,
	        width: '800px'
    	}
    	
		const sendValue = { ...defaults, ...sendObj };
    	
    	console.info( 'Modal open req : ', JSON.stringify(sendValue) ); 

    	if( ! sendValue.url ){
    		console.warn("❌ [openPopup Error] 'url' 값이 필수입니다.");
			throw new Error("❌ [openPopup Error] 'url' 값이 필수입니다.");
		}
    	
    	if( ! sendValue.popupId ){
    		console.warn("❌ [openPopup Error] 'popupId' 값이 필수입니다.");
			throw new Error("❌ [openPopup Error] 'popupId' 값이 필수입니다.");
		}

    	if( ! sendValue.NotCheck ){
    		console.info( 'Modal open Refresh Check ' );
        	const refresh = await checkAndRefreshToken();
        	if( ! refresh ){
        		console.warn('❌ [authCheck Error] 인증 필요.');
        		//throw new Error("❌ [authCheck Error] 인증 필요.");
        		return;
        	}
    	}
		
    	
    	// ✅ 로딩 화면 보이기
        const loading = document.getElementById("loadingOverlay");
        if (loading) loading.classList.remove("hidden");
        
		const width = sendValue.width;
		
        // 데이터 로드
        apiRequest(sendValue.url, {
	            method: sendValue.method,
	            headers: { "Content-Type": sendValue.contentType },
	            body: sendValue.data
	    	})
        	.then(response => {
        		if (!response.ok) {
        			// HTTP 상태 코드가 200이 아니면 예외 발생
        			throw new Error(`HTTP 오류 발생: ${response.status} ${response.statusText}`);
        		}
        		return response.text(); // 정상적인 경우 HTML 반환
        	})
        	.then(html => {
        		
        		popupIndex++; // 새로운 팝업 ID 증가

                // 기존 팝업 컨테이너 복제
                const originalPopup = document.getElementById("popupOverlay");
                const newPopup = originalPopup.cloneNode(true);

                // 새로운 팝업 ID 변경
                const newPopupId = `popupOverlay_${popupIndex}`;
                const newWindowId = `popupWindow_${popupIndex}`;
                const newContentId = `popupContentContainer_${popupIndex}`;

                newPopup.id = newPopupId;
                const popupWindow = newPopup.querySelector("#popupWindow");
                popupWindow.id = newWindowId;
                // width 적용
                popupWindow.style.width = width;
                newPopup.querySelector("#popupContentContainer").id = newContentId;

                // 모달 개별 드래그 객체 추가
                popupWindow.dragObj = { isDragging: false, offsetX: 0, offsetY: 0 };

                // 새 팝업 숨김 해제
                newPopup.classList.remove("hidden");

                // 새로운 팝업 추가
                document.getElementById("popupContainer").appendChild(newPopup);
                
        		const container = document.getElementById(newContentId);
        		container.innerHTML = html;
        		
        		// 새로 추가된 script 태그 실행 (Thymeleaf script 실행)
        		console.info('popupIndex', popupIndex);
        		
           		container.querySelectorAll("script").forEach(oldScript => {
           			const newScript = document.createElement("script");

           		    if (oldScript.src) {
           		        newScript.src = oldScript.src;
           		    } else {
           		        newScript.textContent = oldScript.textContent;
           		    }

           		    // 기존 script 속성 복사
           		    [...oldScript.attributes].forEach(attr => {
           		        newScript.setAttribute(attr.name, attr.value);
           		    });

           		    // popupIndex 기반 식별자 추가
           		    newScript.dataset.popupId = `popupOverlay_${popupIndex}`;

           		    oldScript.remove();
           		    document.body.appendChild(newScript);
           		});
        		
        		// ✅ 로딩 화면 숨기기
                if (loading) loading.classList.add("hidden");
        	})
        	.catch(error => {
        		console.error("에러 발생:", error)
        		if (loading) loading.classList.add("hidden");
        	});
    }

    // 팝업 닫기 함수 (해당 모달만 닫기)
    function closePopup(buttonElement) {
	    const modal = buttonElement.closest(".fixed");
	
	    if (! modal) {
	    	return;
	    }
	    
        const modalId = modal.id;
        console.info(`🔒 모달 제거: ${modalId}`);

        // ✅ 1. 내부 요소 초기화 (메모리 릴리즈 유도)
        modal.querySelectorAll("*").forEach(el => {
            if (el.tagName !== "SCRIPT") {
                el.textContent = '';
                el.innerHTML = '';
            }
        });

        // ✅ 2. 관련 script 제거 (data-popup-id or src 기준)
        const scripts = document.getElementsByTagName('script');
        for (let i = scripts.length - 1; i >= 0; i--) {
            const script = scripts[i];

            // src 기반 제거
            if (script.src && script.src.includes(modalId)) {
                console.info(`🧹 외부 스크립트 제거: ${script.src}`);
                script.parentNode.removeChild(script);
            }

            // data-popup-id 기반 제거
            if (script.dataset && script.dataset.popupId === modalId) {
                console.info(`🧹 인라인 스크립트 제거: ${modalId}`);
                script.parentNode.removeChild(script);
            }
        }

        // ✅ 3. 모달 DOM 제거
        modal.remove();
	}

    
	// 드래그 시작 함수 (각 모달별 dragObj 사용)
    function startDrag(event, headerElement) {
        const popup = headerElement.closest(".modalTop"); // 현재 모달 찾기
        if (!popup) return;

        popup.dragObj.isDragging = true;
        popup.dragObj.offsetX = event.clientX - popup.offsetLeft;
        popup.dragObj.offsetY = event.clientY - popup.offsetTop;

        // 개별 모달에 이벤트 등록
        document.addEventListener("mousemove", (e) => doDrag(e, popup));
        document.addEventListener("mouseup", (e) => stopDrag(e, popup));
    }

    // 드래그 중 (각 모달별 dragObj 참조)
    function doDrag(event, popup) {
        if (!popup.dragObj.isDragging) return;
        popup.style.position = "absolute";
        popup.style.left = event.clientX - popup.dragObj.offsetX + "px";
        popup.style.top = event.clientY - popup.dragObj.offsetY + "px";
    }

    // 드래그 종료 (각 모달별 이벤트 제거)
    function stopDrag(event, popup) {
        popup.dragObj.isDragging = false;
        document.removeEventListener("mousemove", (e) => doDrag(e, popup));
        document.removeEventListener("mouseup", (e) => stopDrag(e, popup));
    }
</script>
</div>
