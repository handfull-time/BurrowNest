<script 
	xmlns:th="http://www.hymeleaf.org" 
	th:inline="javascript"
	th:fragment="CommonScript">

async function checkAndRefreshToken() {
	// ì¿ í‚¤ í¬í•¨
    const options = {
        method: "GET",
        credentials: "include",
        headers: {
            "Content-Type": "application/json"
        }
    };
	
	const url = /*[[@{/Auth/Check.json}]]*/ null;
    console.info('ğŸš€ request', url, 'options', options);
    
    let response = await fetch(url, options);
    
    console.info('âœ… response', response);

    let result = true;
    if (response.status === 401) {
    	console.info('status', response.status, 'Refresh Tokenìœ¼ë¡œ ì¬ë°œê¸‰')
        const refreshSuccess = await refreshToken();
        if (! refreshSuccess) {
            throw new Error("ì¬ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        }
    }

    return result;
}


//ì‚¬ìš© ì˜ˆ)
//const response = await apiRequest("/user/profile");
//if (response.ok) {
//  const data = await response.json();
//  console.log(data);
//}

async function apiRequest(url, options = {}) {
	// ì¿ í‚¤ í¬í•¨
    options.credentials = 'include';
	
    console.info('ğŸš€ request', url, 'options', options);
    
    let response = await fetch(url, options);
    
    console.info('âœ… response', response);

    if (response.status === 401) {
    	console.info('status', response.status, 'Refresh Tokenìœ¼ë¡œ ì¬ë°œê¸‰')
        const refreshSuccess = await refreshToken();
        if (refreshSuccess) {
            // ì¬ë°œê¸‰ í›„ ë‹¤ì‹œ ìš”ì²­
            response = await fetch(url, options);
            
            console.info('âœ… response', response);
        } else {
            throw new Error("ì¬ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        }
    }

    return response;
}

/* 
async function apiRequest(url, method = "GET", body = null) {
    const options = {
        method: method || "GET",
        credentials: "include", // ì¿ í‚¤ í¬í•¨
        headers: {
            "Content-Type": "application/json"
        }
    };

    if (body){
    	options.body = JSON.stringify(body);
    }

    console.info('ğŸš€ request', url, 'options', options);
    
    let response = await fetch(url, options);
    
    console.info('âœ… response', response);
    
    if (response.status === 401) {
    	console.info('status', response.status, 'Refresh Tokenìœ¼ë¡œ ì¬ë°œê¸‰')
    	
        const refreshSuccess = await refreshToken();
        if (refreshSuccess) {
            // ì¬ë°œê¸‰ í›„ ë‹¤ì‹œ ìš”ì²­
            response = await fetch(url, options);
            
            console.info('âœ… response', response);
        } else {
            throw new Error("ì¬ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        }
    }

    return response;
}
 */

// Refresh Token í˜¸ì¶œ í•¨ìˆ˜
async function refreshToken() {
	
	console.info('ğŸš€ request, Refresh');
	
    try {
        const res = await fetch(/*[[@{/Auth/Refresh.json}]]*/ null, {
            method: 'POST',
            credentials: 'include'
        });
        
        console.info('âœ… response', res);

        if (!res.ok) {
        	showCustomAlert("ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ì„¸ìš”.", () => {
        		window.location.href = /*[[@{/Auth/Login.html}]]*/ null;
        	});
            
            return false;
        }
        return true;
    } catch (err) {
        console.error("refreshToken ì‹¤íŒ¨:", err);
        return false;
    }
}

 
function buttonStatus( btnId, status ){
	const btn = document.getElementById(btnId);
	if( ! btn ){
		console.warn('btnIdë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
		return;
	}
	
	if( status ){
		btn.disabled = false;
		btn.classList.remove("bg-gray-500", "text-black", "hover:bg-gray-600");
		btn.classList.add("bg-blue-500", "text-white", "hover:bg-blue-600");
	}else{
		btn.disabled = true;
		btn.classList.remove("bg-blue-500", "text-white", "hover:bg-blue-600");
		btn.classList.add("bg-gray-500", "text-black", "hover:bg-gray-600");
	}
}
</script>