<script 
	xmlns:th="http://www.hymeleaf.org" 
	th:inline="javascript"
	th:fragment="CommonScript">

async function checkAndRefreshToken() {
	// 쿠키 포함
    const options = {
        method: "GET",
        credentials: "include",
        headers: {
            "Content-Type": "application/json"
        }
    };
	
	const url = /*[[@{/Auth/Check.json}]]*/ null;
    console.info('🚀 request', url, 'options', options);
    
    let response = await fetch(url, options);
    
    console.info('✅ response', response);

    let result = true;
    if (response.status === 401) {
    	console.info('status', response.status, 'Refresh Token으로 재발급')
        const refreshSuccess = await refreshToken();
        if (! refreshSuccess) {
            throw new Error("재로그인이 필요합니다.");
        }
    }

    return result;
}


//사용 예)
//const response = await apiRequest("/user/profile");
//if (response.ok) {
//  const data = await response.json();
//  console.log(data);
//}

async function apiRequest(url, options = {}) {
	// 쿠키 포함
    options.credentials = 'include';
	
    console.info('🚀 request', url, 'options', options);
    
    let response = await fetch(url, options);
    
    console.info('✅ response', response);

    if (response.status === 401) {
    	console.info('status', response.status, 'Refresh Token으로 재발급')
        const refreshSuccess = await refreshToken();
        if (refreshSuccess) {
            // 재발급 후 다시 요청
            response = await fetch(url, options);
            
            console.info('✅ response', response);
        } else {
            throw new Error("재로그인이 필요합니다.");
        }
    }

    return response;
}

/* 
async function apiRequest(url, method = "GET", body = null) {
    const options = {
        method: method || "GET",
        credentials: "include", // 쿠키 포함
        headers: {
            "Content-Type": "application/json"
        }
    };

    if (body){
    	options.body = JSON.stringify(body);
    }

    console.info('🚀 request', url, 'options', options);
    
    let response = await fetch(url, options);
    
    console.info('✅ response', response);
    
    if (response.status === 401) {
    	console.info('status', response.status, 'Refresh Token으로 재발급')
    	
        const refreshSuccess = await refreshToken();
        if (refreshSuccess) {
            // 재발급 후 다시 요청
            response = await fetch(url, options);
            
            console.info('✅ response', response);
        } else {
            throw new Error("재로그인이 필요합니다.");
        }
    }

    return response;
}
 */

// Refresh Token 호출 함수
async function refreshToken() {
	
	console.info('🚀 request, Refresh');
	
    try {
        const res = await fetch(/*[[@{/Auth/Refresh.json}]]*/ null, {
            method: 'POST',
            credentials: 'include'
        });
        
        console.info('✅ response', res);

        if (!res.ok) {
        	showCustomAlert("세션이 만료되었습니다. 다시 로그인하세요.", () => {
        		window.location.href = /*[[@{/Auth/Login.html}]]*/ null;
        	});
            
            return false;
        }
        return true;
    } catch (err) {
        console.error("refreshToken 실패:", err);
        return false;
    }
}

 
function buttonStatus( btnId, status ){
	const btn = document.getElementById(btnId);
	if( ! btn ){
		console.warn('btnId를 찾을 수 없습니다.');
		return;
	}
	
	if( status ){
		btn.disabled = false;
		btn.classList.remove("bg-gray-500", "text-black", "hover:bg-gray-600");
		btn.classList.add("bg-blue-500", "text-white", "hover:bg-blue-600");
	}else{
		btn.disabled = true;
		btn.classList.remove("bg-blue-500", "text-white", "hover:bg-blue-600");
		btn.classList.add("bg-gray-500", "text-black", "hover:bg-gray-600");
	}
}

/*
function getFormObject(formId) {

    const form = document.getElementById(formId);
    
    const formData = new FormData(form);
    
    const result = {};
    formData.forEach((value, key) => {
		
		const keys = key.split('.'); // Split key into array of keys
        let obj = result;

        for (let i = 0; i < keys.length; i++) {
            const k = keys[i];

            if (i === keys.length - 1) {
                // If it's the last key, set the value
                if (Array.isArray(obj[k])) {
                    obj[k].push(value);
                } else if (obj[k] !== undefined) {
                    obj[k] = [obj[k], value];
                } else {
                    obj[k] = value;
                }
            } else {
                // If it's not the last key, ensure the nested object exists
                if (!obj[k]) {
                    obj[k] = {};
                }
                obj = obj[k];
            }
        }
    });
    
    console.log( JSON.stringify(result, null, 4 ) );
    
    return result;
}
*/

function getFormObject(formId) {
    const form = document.getElementById(formId);
    if (!form) {
    	throw new Error(`Form with ID "${formId}" not found.`);
    }

    const result = {};
    const elements = Array.from(form.elements);

    for (const el of elements) {
        if (!el.name || el.disabled) continue;

        const { name, type, value, checked, tagName } = el;
        const isCheckbox = type === 'checkbox';
        const isRadio = type === 'radio';

        if (isCheckbox) {
            if (checked) _setDeepValue(result, name, value, true);
        } else if (isRadio) {
            if (checked) _setDeepValue(result, name, value);
        } else if (tagName === 'SELECT' && el.multiple) {
            const selectedValues = Array.from(el.selectedOptions).map(opt => opt.value);
            _setDeepValue(result, name, selectedValues, true);
        } else {
            _setDeepValue(result, name, value);
        }
    }

    console.log(JSON.stringify(result, null, 4));
    return result;

    // 👇 내부 유틸 함수
    function _setDeepValue(obj, path, value, forceArray = false) {
        const keys = path.split('.');
        let current = obj;

        keys.forEach((key, index) => {
            const isLast = index === keys.length - 1;

            if (isLast) {
                if (key in current) {
                    if (!Array.isArray(current[key])) {
                        current[key] = [current[key]];
                    }
                    current[key].push(value);
                } else {
                    current[key] = forceArray ? [value] : value;
                }
            } else {
                if (!(key in current) || typeof current[key] !== 'object') {
                    current[key] = {};
                }
                current = current[key];
            }
        });
    }
}


</script>