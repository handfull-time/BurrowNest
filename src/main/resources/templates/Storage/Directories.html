<div th:fragment="directories" xmlns:th="http://www.thymeleaf.org" class="p-2 text-sm bg-white text-black select-none">
  <ul id="directoryTree" class="space-y-1">
    <li th:replace="~{this :: directoryNode(dir=${directoryTree})}"></li>
  </ul>

  <!-- 템플릿은 자바스크립트에서만 사용 -->
  <template id="dirItemTemplate">
    <li>
      <div class="flex items-center gap-1">
        <button class="toggle-btn text-blue-600" data-path="" data-loaded="false">[+]</button>
        <span class="grow text-black cursor-pointer" data-path="">폴더명</span>
      </div>
      <ul class="pl-4 hidden" data-children-for=""></ul>
    </li>
  </template>
</div>

<li xmlns:th="http://www.thymeleaf.org"  th:fragment="directoryNode(dir)">
  <div class="flex items-center gap-1">
    <button th:if="${dir.hasChildren}" class="toggle-btn text-blue-600" th:attr="data-path=${dir.path}" data-loaded="false">[+]</button>
    <span class="grow text-black cursor-pointer"
          th:attr="data-path=${dir.path}"
          th:classappend="${dir.selected} ? ' bg-blue-100' : ''"
          th:text="${dir.name}">폴더명</span>
  </div>
  
  <th:block th:if="${dir.subDirectories != null and !dir.subDirectories.isEmpty()}">
  	<th:block th:each="sub : ${dir.subDirectories}">
	  	<ul class="pl-4" th:data-children-for="${sub.path}" >
	    	<li th:replace="~{this :: directoryNode(dir=${sub})}"></li>
	  	</ul>
  	</th:block> 
  </th:block>
  <th:block th:unless="${dir.subDirectories == null or dir.subDirectories.isEmpty()}">
  	<ul class="pl-4 hidden" data-children-for="" ></ul>
  </th:block>
</li>

<script xmlns:th="http://www.thymeleaf.org" th:fragment="script" th:inline="javascript">

async function innerLoad(template, toggleBtn, container, parentPath){
	try {
		let urlAddress = /*[[@{/Dir/List.json}]]*/ null;
		urlAddress += '?path=' + encodeURIComponent(parentPath);
		
		console.info('urlAddress', urlAddress);
		
		const response = await fetch(`${urlAddress}`, {
			 method: "GET",
			 credentials: "include"
		});
		const list = await response.json();
		
		list.forEach(item => {
			const clone = template.content.cloneNode(true);
			const btn = clone.querySelector('.toggle-btn');
			const label = clone.querySelector('span[data-path]');
			const ul = clone.querySelector('ul');
			
			const fullPath = `${parentPath.replace(/\/$/, "")}/${item.name}`;
			
			// 라벨 설정
			label.textContent = item.name;
			label.dataset.path = fullPath;
			
			// 버튼 설정
			if (item.hasChildren) {
				btn.dataset.path = fullPath;
				btn.dataset.loaded = "false";
				btn.textContent = "[+]";
			} else {
				btn.remove();
			}

			// 하위 디렉토리 컨테이너 설정
			if (ul) {
				ul.dataset.childrenFor = fullPath;
				ul.classList.remove("hidden"); // 또는 기본은 hidden 유지
			}
			
			container.appendChild(clone);
		});
		
		toggleBtn.dataset.loaded = "true";
	} catch (err) {
		console.error("디렉토리 로딩 실패:", err);
	}
}

document.addEventListener("DOMContentLoaded", () => {
	const treeRoot = document.getElementById("directoryTree");
	const template = document.getElementById("dirItemTemplate");
	
	treeRoot.addEventListener("click", async (e) => {
		const toggleBtn = e.target.closest(".toggle-btn");
		if (toggleBtn) {
			const parentPath = toggleBtn.dataset.path;
			const li = toggleBtn.closest("li");
			let container = li.querySelector(`ul[data-children-for="${parentPath}"]`);

			// 없으면 새로 생성
			if (!container) {
				container = document.createElement("ul");
				container.classList.add("pl-4");
				container.dataset.childrenFor = parentPath;
				li.appendChild(container);
			}
			
			// 펼치기/접기 토글
			if (toggleBtn.textContent === "[+]") {
				toggleBtn.textContent = "[-]";
				
				if (! (toggleBtn.dataset.loaded === "true")) {
					await innerLoad(template, toggleBtn, container, parentPath );
				}
			} else {
				container.classList.add("hidden");
				toggleBtn.textContent = "[+]";
			}
			
			return;
		}
		
		// 폴더 이름 클릭 시
		const label = e.target.closest("span[data-path]");
		if (label) {
			const clickedPath = label.dataset.path;
			console.log("Clicked folder:", clickedPath);
			
			// ✅ 선택된 경로로 이동
			const baseUrl = /*[[@{/Dir/Path.html}]]*/ null;
			window.location.href = `${baseUrl}?path=${encodeURIComponent(clickedPath)}`;
		}
	});
});
</script>
