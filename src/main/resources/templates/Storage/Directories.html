<div 
	xmlns:th="http://www.thymeleaf.org" 
	th:fragment="directories" 
	class="p-2 text-sm bg-white text-black select-none">
  
<div id="tree-root" class="max-w-xl mx-auto bg-white shadow rounded-lg p-4 font-mono text-sm" role="tree"></div>


<script th:inline="javascript">

const closedFolder = `
    <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v1H2V6z"/>
    <path d="M2 9h16v5a2 2 0 01-2 2H4a2 2 0 01-2-2V9z"/>
  `;
  const openFolder = `
    <path d="M3 4a2 2 0 012-2h4l2 2h6a2 2 0 012 2v1H3V4z"/>
    <path d="M2 8h17l-1.5 6.5a2 2 0 01-2 1.5H5a2 2 0 01-2-2V8z"/>
  `;

  function createTreeNode(node, parentOpened = false) {
	  
	  if( typeof node.isCreated === "undefined") {
		  node.isCreated = true;
	  }

	  const li = document.createElement('li');
	  li.className = "mb-1";
	  li.setAttribute("role", "treeitem");
	
	  const row = document.createElement('div');
	  row.className = "flex items-center space-x-1 cursor-pointer group";
	  row.dataset.node = "";
	  
	  const chevron = document.createElementNS("http://www.w3.org/2000/svg", "svg");
	  chevron.setAttribute("viewBox", "0 0 24 24");
	  chevron.setAttribute("fill", "none");
	  chevron.setAttribute("stroke", "currentColor");
	  chevron.setAttribute("class", "w-4 h-4 text-gray-500 transition-transform");
	  chevron.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />`;
	
	  const folderIcon = document.createElementNS("http://www.w3.org/2000/svg", "svg");
	  folderIcon.setAttribute("viewBox", "0 0 20 20");
	  folderIcon.setAttribute("fill", "currentColor");
	  folderIcon.setAttribute("class", "w-5 h-5 text-yellow-500 folder-icon");
	  folderIcon.innerHTML = closedFolder;
	  folderIcon.setAttribute("aria-expanded", "false");
	
	  const label = document.createElement("span");
	  label.textContent = node.name;
	  label.className = "folder-label";
	
	  row.appendChild(chevron);
	  row.appendChild(folderIcon);
	  row.appendChild(label);
	  li.appendChild(row);
	
	  let isOpen = false;
	
	  if (node.childDirectories && node.childDirectories.length > 0) {
		  
	      const ul = document.createElement('ul');
	      ul.className = "ml-6 mt-1 space-y-1 hidden";
	      ul.dataset.childDirectories = "";
	      
	      node.childDirectories.forEach(child => {
	        const childNode = createTreeNode(child);
	        if (childNode.dataset.containsSelected === "true") {
	            isOpen = true;
	        }
	        ul.appendChild(childNode);
	      });
	      
	      if (isOpen || node.selected || parentOpened) {
	          row.classList.add("open");
	          ul.classList.remove("hidden");
	          chevron.classList.add("rotate-90");
	          folderIcon.innerHTML = openFolder;
	          folderIcon.setAttribute("aria-expanded", "true");
	          if (node.selected) {
	              label.classList.add("text-blue-600", "font-bold", "bg-blue-100", "px-1", "rounded");
	          }
	          li.dataset.containsSelected = "true";
	      }
	      
	      li.appendChild(ul);
	      
	      row.addEventListener("click", (e) => {
	          e.stopPropagation();
	          
	          row.classList.toggle("open");
	          ul.classList.toggle("hidden");
	          chevron.classList.toggle("rotate-90");
	          folderIcon.innerHTML = row.classList.contains("open") ? openFolder : closedFolder;
	          folderIcon.setAttribute("aria-expanded", row.classList.contains("open"));
	          
	          document.querySelectorAll(".folder-label").forEach(el => el.classList.remove("text-blue-600", "font-bold", "bg-blue-100", "px-1", "rounded"));
	          label.classList.add("text-blue-600", "font-bold", "bg-blue-100", "px-1", "rounded");
	          
	          const event = new CustomEvent("treeItemClick", { detail: node });
	  	      document.dispatchEvent(event);
	      });
	  } else {
	      chevron.classList.add("opacity-0");
	      if (node.selected) {
	          label.classList.add("text-blue-600", "font-bold", "bg-blue-100", "px-1", "rounded");
	          li.dataset.containsSelected = "true";
	      }
	      
	      row.addEventListener("click", (e) => {
	          e.stopPropagation();
	          document.querySelectorAll(".folder-label").forEach(el => el.classList.remove("text-blue-600", "font-bold", "bg-blue-100", "px-1", "rounded"));
	          label.classList.add("text-blue-600", "font-bold", "bg-blue-100", "px-1", "rounded");
	          
	          const event = new CustomEvent("treeItemClick", { detail: node });
	  	      document.dispatchEvent(event);
	      });
	  }
	
	  return li;
  }
  
  document.addEventListener("treeItemClick", (e) => {
	  const dir = e.detail;
	  
	  if( typeof dir.isCreated !== "undefined") {
		  // 생성 된 데이터다.
		  return;
	  }
	  
	  const url = /*[[@{/Dir/Path.html}]]*/ null;
	  const params = new URLSearchParams({
		  uid: dir.uid || ''
	  });
	  
	  window.location.href = url + '?' + params.toString();
  });


  document.addEventListener('DOMContentLoaded', function() {
	  const params = new URLSearchParams({
		  uid: data.uid || ''
	  });
      
	  const url = /*[[@{/Dir/Path.html}]]*/ null;
      const urlValue = url + '?' + params.toString();
      
      // 이건 사용 기록 덮어쓰기
	  window.history.replaceState(null, null, urlValue);
      
      // 이건 사용 기록 추가하기.
	  //window.history.pushState(null, null, urlValue);

	  storage

	  const ul = document.createElement('ul');
	  ul.className = "space-y-1";
	  ul.appendChild( createTreeNode(data) );
	  ocument.getElementById("tree-root").appendChild(ul);
  });

</script>
</div>
