<div xmlns:th="http://www.thymeleaf.org" th:fragment="directories"
	class="p-2 text-sm bg-white text-black select-none">

	<ul id="directoryTree"
	       class="space-y-1 max-h-[600px] overflow-auto border rounded p-2 bg-white"></ul>

	<!-- 디렉터리 전용 템플릿 -->
	<template id="dirItemTemplate">
		<li>
			<div class="flex items-center gap-1 select-none">
				<!-- 토글 버튼(폴더만 존재) -->
				<button class="toggle-btn text-gray-500 w-4 h-4 flex items-center justify-center"
				    data-uid="" data-loaded="false" aria-label="toggle" title="toggle">
				  ▶
				</button>
				
				<!-- 폴더 아이콘 + 이름 -->
				<span class="icon text-gray-600">📁</span>
				<span class="text-sm text-gray-800 cursor-pointer dir-label" data-uid="">폴더명</span>
			</div>
			
			<!-- 하위 디렉터리 컨테이너 -->
			<ul class="pl-5 hidden" data-children-for=""></ul>
		</li>
	</template>

	<th:script th:replace="~{Storage/StorageScript :: script}" />
	<th:div th:replace="~{Storage/CustomSubMenu :: customMenu}" />
	<script th:inline="javascript">

	// 초기 로딩 (root)
	loadDirectory(null, document.getElementById("directoryTree"));
	
	// 클릭 위임: 라벨/토글 모두로 열고 닫기
	document.getElementById("directoryTree").addEventListener("click", async (e) => {
		const label = e.target.closest(".dir-label");
		const toggleBtn = e.target.closest(".toggle-btn");
		
		if (label) {
			const li = label.closest("li");
			const btn = li.querySelector(".toggle-btn");
			if (btn) await toggleNode(btn);
				return;
		}
		if (toggleBtn) {
			await toggleNode(toggleBtn);
		}
	});
	
	async function toggleNode(toggleBtn) {
		const uid = toggleBtn.dataset.uid;
		const li = toggleBtn.closest("li");
		const container = li.querySelector("ul");
		const icon = li.querySelector(".icon");
		
		const isClosed = toggleBtn.textContent.trim() === "▶";
		if (isClosed) {
			toggleBtn.textContent = "▼";
			if (icon) icon.textContent = "📂";
			if (toggleBtn.dataset.loaded !== "true") {
				await loadDirectory(uid, container);
				toggleBtn.dataset.loaded = "true";
			}
			container.classList.remove("hidden");
		} else {
		  toggleBtn.textContent = "▶";
		  if (icon) icon.textContent = "📁";
		  container.classList.add("hidden");
		}
	}

	// 디렉터리 로딩 (디렉터리만 반환된다고 가정)
	async function loadDirectory(uid, container) {
		const template = document.getElementById("dirItemTemplate");
		try {
			const baseUrl = /*[[@{/Storage/Dir/PathList.json}]]*/ null;
			
			const params = new URLSearchParams({ uid: uid });
			const options = {
				method: "GET",
				headers: { "Content-Type": "application/x-www-form-urlencoded" },
			};
			
			const urlAddress = baseUrl + "?" + params.toString();
			const response = await apiRequest(urlAddress, options);
			const list = await response.json();
			// 기대 응답 예시(디렉터리만):
			// [{ uid:"...", name:"admin", hasChild:true }, { uid:"...", name:"common", hasChild:true }, ...]
			
			list.forEach(item => {
				const frag = template.content.cloneNode(true);
				
				const toggleBtn = frag.querySelector(".toggle-btn");
				const label = frag.querySelector(".dir-label");
				const icon = frag.querySelector(".icon");
				const ul = frag.querySelector("ul");
				
				label.textContent = item.name;
				label.dataset.uid = item.uid;
				
				ul.dataset.childrenFor = item.uid;
				ul.classList.add("hidden");
				
				if (item.hasChild) {
					toggleBtn.dataset.uid = item.uid;
					toggleBtn.dataset.loaded = "false";
					toggleBtn.textContent = "▶";
					icon.textContent = "📁";
				} else {
					// 하위가 없으면 토글 버튼 감춤, 아이콘은 닫힌 폴더로 유지
					toggleBtn.remove();
					icon.textContent = "📁";
				}
				
				container.appendChild(frag);
			});
		} catch (err) {
			console.error("디렉터리 로딩 오류:", err);
		}
	}

</script>
</div>
