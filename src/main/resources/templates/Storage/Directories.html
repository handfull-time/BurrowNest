<div 
	xmlns:th="http://www.thymeleaf.org" 
	th:fragment="directories" 
	class="p-2 text-sm bg-white text-black select-none">
  
<div id="tree" class="max-w-xl mx-auto bg-white shadow rounded-lg p-4 font-mono text-sm" role="tree"></div>

<template id="treeNodeTemplate">
  <li class="mb-1" role="treeitem">
    <div class="flex items-center space-x-1 cursor-pointer group" data-node="true">
      <svg class="chevron w-4 h-4 text-gray-500 transition-transform"
           viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 5l7 7-7 7"/>
      </svg>
      <svg class="folder-icon w-5 h-5 text-yellow-500" viewBox="0 0 20 20" fill="currentColor">
        <!-- 아이콘은 JS에서 open/close 교체 -->
      </svg>
      <span class="folder-label"></span>
    </div>
  </li>
</template>


<div>
    <button id="openBtn" class="px-3 py-1 bg-blue-500 text-white rounded">열기</button>
    <button id="copyBtn" class="px-3 py-1 bg-blue-500 text-white rounded">복사</button>
    <button id="cutBtn" class="px-3 py-1 bg-yellow-500 text-white rounded">잘라내기</button>
    <button id="pasteBtn" class="px-3 py-1 bg-green-500 text-white rounded" disabled>붙여넣기</button>
    <button id="renameBtn" class="px-3 py-1 bg-blue-500 text-white rounded">이름변경</button>
    <button id="detailBtn" class="px-3 py-1 bg-blue-500 text-white rounded">속성</button>
</div>

<th:script th:replace="~{Storage/StorageScript :: script}"/>
<th:div th:replace="~{Storage/CustomSubMenu :: customMenu}"/>
<script th:inline="javascript">

	const closedFolder = `
	  <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v1H2V6z"/>
	  <path d="M2 9h16v5a2 2 0 01-2 2H4a2 2 0 01-2-2V9z"/>
	`;
	
	const openFolder = `
	  <path d="M3 4a2 2 0 012-2h4l2 2h6a2 2 0 012 2v1H3V4z"/>
	  <path d="M2 8h17l-1.5 6.5a2 2 0 01-2 1.5H5a2 2 0 01-2-2V8z"/>
	`;

	function createTree(directories, container) {
	  const rootUl = document.createElement("ul");
	  rootUl.setAttribute("role", "tree");
	  directories.forEach(dir => {
	    rootUl.appendChild(createTreeNode(dir, false));
	  });
	  container.innerHTML = '';
	  container.appendChild(rootUl);
	}
	
	function createTreeNode(node, parentOpened = false) {
	  const template = document.getElementById("treeNodeTemplate");
	  const clone = template.content.cloneNode(true);
	  const li = clone.querySelector('li');
	  const row = clone.querySelector('[data-node]');
	  const chevron = clone.querySelector('.chevron');
	  const folderIcon = clone.querySelector('.folder-icon');
	  const label = clone.querySelector('.folder-label');

	  row._nodeData = node;
	  label.textContent = node.owner.name;

	  let isOpen = false;

	  if (node.child && node.child.length > 0) {
	    const ul = document.createElement('ul');
	    ul.className = "ml-6 mt-1 space-y-1 hidden";
	    ul.dataset.childDirectories = "";

	    node.child.forEach(child => {
	      const childNode = createTreeNode(child, false);
	      if (childNode?.dataset?.containsSelected === "true") {
	        isOpen = true;
	      }
	      ul.appendChild(childNode);
	    });

	    if (isOpen || node.selected || parentOpened) {
	      row.classList.add("open");
	      ul.classList.remove("hidden");
	      chevron.classList.add("rotate-90");
	      folderIcon.innerHTML = openFolder;
	      folderIcon.setAttribute("aria-expanded", "true");

	      if (node.selected) {
	        label.classList.add("text-blue-600", "font-bold", "bg-blue-100", "px-1", "rounded");
	      }

	      li.dataset.containsSelected = "true";
	    } else {
	      folderIcon.innerHTML = closedFolder;
	      folderIcon.setAttribute("aria-expanded", "false");
	    }

	    li.appendChild(ul);

	    row.addEventListener("click", (e) => {
	      e.stopPropagation();
	      row.classList.toggle("open");
	      ul.classList.toggle("hidden");
	      chevron.classList.toggle("rotate-90");
	      const isNowOpen = row.classList.contains("open");
	      folderIcon.innerHTML = isNowOpen ? openFolder : closedFolder;
	      folderIcon.setAttribute("aria-expanded", isNowOpen);

	      document.querySelectorAll(".folder-label").forEach(el => el.classList.remove("text-blue-600", "font-bold", "bg-blue-100", "px-1", "rounded"));
	      label.classList.add("text-blue-600", "font-bold", "bg-blue-100", "px-1", "rounded");

	      if (onSelected) onSelected(node);
	    });
	  } else {
	    chevron.classList.add("opacity-0");
	    folderIcon.innerHTML = closedFolder;
	    folderIcon.setAttribute("aria-expanded", "false");

	    if (node.selected) {
	      label.classList.add("text-blue-600", "font-bold", "bg-blue-100", "px-1", "rounded");
	      li.dataset.containsSelected = "true";
	    }

	    row.addEventListener("click", (e) => {
	      e.stopPropagation();
	      document.querySelectorAll(".folder-label").forEach(el => el.classList.remove("text-blue-600", "font-bold", "bg-blue-100", "px-1", "rounded"));
	      label.classList.add("text-blue-600", "font-bold", "bg-blue-100", "px-1", "rounded");

	      if (onSelected) onSelected(node);
	    });
	  }

	  if (node.selected && onSelected) {
	    setTimeout(() => onSelected(node), 0);
	  }

	  return li;
	}

    const storage = new BnStorage();

    function updatePasteButton() {
        const pasteBtn = document.getElementById("pasteBtn");
        const pasteLi = document.querySelector("#contextMenuFolder [data-action='paste']");
        const available = storage.isClipboardAvailable();

        pasteBtn.disabled = !available;
        pasteLi.classList.toggle("text-gray-400", !available);
        pasteLi.classList.toggle("cursor-not-allowed", !available);
        pasteLi.classList.toggle("cursor-pointer", available);
    }

    // 이벤트 연결
    document.getElementById("copyBtn").addEventListener("click", () => {
      storage.copyDirectory();
      updatePasteButton();
    });

    document.getElementById("cutBtn").addEventListener("click", () => {
      storage.cutDirectory();
      updatePasteButton();
    });

    document.getElementById("pasteBtn").addEventListener("click", async () => {
      const current = storage.getSelectedDirectory();
      if (!current) return alert("선택된 디렉토리가 없습니다.");
      await storage.pasteDirectory(current.owner.uid);
      alert("붙여넣기 완료!");
      storage.clearClipboard();
      updatePasteButton();
    });

    function onSelected( selected ){
    	console.info( 'selected', selected.owner.name );
		
		storage.selectDirectory(selected);
		updatePasteButton();
		loadFileList( selected.owner.uid );
    }
    
	document.addEventListener('DOMContentLoaded', function() {
		console.info( "여기가 시작이다." );
		
		const directories = /*[[${directories}]]*/ null;
		
	    // 초기 선택 처리
	    const selectedUid = /*[[${selectedUid}]]*/ null;
	    if( selectedUid !== null ){
		    const selectedNode = findNodeByUid(directories, selectedUid);
		    if (selectedNode) {
		      selectedNode.selected = true;
		    }
	    }
	    
	    const node = findSelectedNode( directories );
	    if( node != null ){
	    	console.info( 'Selected Node' , node.owner.name );
	    }
		
		// 디렉토리 트리 렌더링
		createTree(directories, document.getElementById("tree"));
		
		// uid로 선택된 노드를 찾기
	    function findNodeByUid(nodes, uid) {
	      for (const node of nodes) {
	        if (node.owner?.uid === uid) return node;
	        if (node.child) {
	          const found = findNodeByUid(node.child, uid);
	          if (found) return found;
	        }
	      }
	      return null;
	    }
		
	    function findSelectedNode(nodes) {
	    	  for (const node of nodes) {
	    	    if (node.selected) return node;
	    	    if (node.child) {
	    	      const found = findSelectedNode(node.child);
	    	      if (found) return found;
	    	    }
	    	  }
	    	  return null;
	    	}


//	  const params = new URLSearchParams({
//		  uid: data.uid || ''
//	  });
      
//	  const url = /*[[@{/Dir/Path.html}]]*/ null;
//      const urlValue = url + '?' + params.toString();
      
//      // 이건 사용 기록 덮어쓰기
//	  window.history.replaceState(null, null, urlValue);
      
      // 이건 사용 기록 추가하기.
	  //window.history.pushState(null, null, urlValue);

	  //const directories = /*[[${directories}]]*/ null;

//	  const ul = document.createElement('ul');
//	  ul.className = "space-y-1";
//	  ul.appendChild( createTreeNode(directories) );
//	  ocument.getElementById("tree-root").appendChild(ul);
  });

</script>
</div>
