<div xmlns:th="http://www.thymeleaf.org" th:fragment="directories"
	class="p-2 text-sm bg-white text-black select-none">

	<ul id="directoryTree"
	       class="space-y-1 max-h-[600px] overflow-auto border rounded p-2 bg-white"></ul>

	<!-- ë””ë ‰í„°ë¦¬ ì „ìš© í…œí”Œë¦¿ -->
	<template id="dirItemTemplate">
		<li>
			<div class="flex items-center gap-1 select-none">
				<!-- í† ê¸€ ë²„íŠ¼(í´ë”ë§Œ ì¡´ì¬) -->
				<button class="toggle-btn text-gray-500 w-4 h-4 flex items-center justify-center"
				    data-uid="" data-loaded="false" aria-label="toggle" title="toggle">
				  â–¶
				</button>
				
				<!-- í´ë” ì•„ì´ì½˜ + ì´ë¦„ -->
				<span class="icon text-gray-600">ğŸ“</span>
				<span class="text-sm text-gray-800 cursor-pointer dir-label" data-uid="">í´ë”ëª…</span>
			</div>
			
			<!-- í•˜ìœ„ ë””ë ‰í„°ë¦¬ ì»¨í…Œì´ë„ˆ -->
			<ul class="pl-5 hidden" data-children-for=""></ul>
		</li>
	</template>

	<th:script th:replace="~{Storage/StorageScript :: script}" />
	<th:div th:replace="~{Storage/CustomSubMenu :: customMenu}" />
	<script th:inline="javascript">

	// ì´ˆê¸° ë¡œë”© (root)
	loadDirectory(null, document.getElementById("directoryTree"));
	
	// í´ë¦­ ìœ„ì„: ë¼ë²¨/í† ê¸€ ëª¨ë‘ë¡œ ì—´ê³  ë‹«ê¸°
	document.getElementById("directoryTree").addEventListener("click", async (e) => {
		const label = e.target.closest(".dir-label");
		const toggleBtn = e.target.closest(".toggle-btn");
		
		if (label) {
			const li = label.closest("li");
			const btn = li.querySelector(".toggle-btn");
			if (btn) await toggleNode(btn);
				return;
		}
		if (toggleBtn) {
			await toggleNode(toggleBtn);
		}
	});
	
	async function toggleNode(toggleBtn) {
		const uid = toggleBtn.dataset.uid;
		const li = toggleBtn.closest("li");
		const container = li.querySelector("ul");
		const icon = li.querySelector(".icon");
		
		const isClosed = toggleBtn.textContent.trim() === "â–¶";
		if (isClosed) {
			toggleBtn.textContent = "â–¼";
			if (icon) icon.textContent = "ğŸ“‚";
			if (toggleBtn.dataset.loaded !== "true") {
				await loadDirectory(uid, container);
				toggleBtn.dataset.loaded = "true";
			}
			container.classList.remove("hidden");
		} else {
		  toggleBtn.textContent = "â–¶";
		  if (icon) icon.textContent = "ğŸ“";
		  container.classList.add("hidden");
		}
	}

	// ë””ë ‰í„°ë¦¬ ë¡œë”© (ë””ë ‰í„°ë¦¬ë§Œ ë°˜í™˜ëœë‹¤ê³  ê°€ì •)
	async function loadDirectory(uid, container) {
		const template = document.getElementById("dirItemTemplate");
		try {
			const baseUrl = /*[[@{/Storage/Dir/PathList.json}]]*/ null;
			
			const params = new URLSearchParams({ uid: uid });
			const options = {
				method: "GET",
				headers: { "Content-Type": "application/x-www-form-urlencoded" },
			};
			
			const urlAddress = baseUrl + "?" + params.toString();
			const response = await apiRequest(urlAddress, options);
			const list = await response.json();
			// ê¸°ëŒ€ ì‘ë‹µ ì˜ˆì‹œ(ë””ë ‰í„°ë¦¬ë§Œ):
			// [{ uid:"...", name:"admin", hasChild:true }, { uid:"...", name:"common", hasChild:true }, ...]
			
			list.forEach(item => {
				const frag = template.content.cloneNode(true);
				
				const toggleBtn = frag.querySelector(".toggle-btn");
				const label = frag.querySelector(".dir-label");
				const icon = frag.querySelector(".icon");
				const ul = frag.querySelector("ul");
				
				label.textContent = item.name;
				label.dataset.uid = item.uid;
				
				ul.dataset.childrenFor = item.uid;
				ul.classList.add("hidden");
				
				if (item.hasChild) {
					toggleBtn.dataset.uid = item.uid;
					toggleBtn.dataset.loaded = "false";
					toggleBtn.textContent = "â–¶";
					icon.textContent = "ğŸ“";
				} else {
					// í•˜ìœ„ê°€ ì—†ìœ¼ë©´ í† ê¸€ ë²„íŠ¼ ê°ì¶¤, ì•„ì´ì½˜ì€ ë‹«íŒ í´ë”ë¡œ ìœ ì§€
					toggleBtn.remove();
					icon.textContent = "ğŸ“";
				}
				
				container.appendChild(frag);
			});
		} catch (err) {
			console.error("ë””ë ‰í„°ë¦¬ ë¡œë”© ì˜¤ë¥˜:", err);
		}
	}

</script>
</div>
