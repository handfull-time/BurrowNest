<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>ğŸ‡ BurrowNest</title>
    <meta charset="UTF-8">

   	<th:block th:replace="~{Common/Favicon :: Favicon}"></th:block>

    <script type="text/javascript" th:src="@{/js/tailwind/tailwind.min.js}"></script>
    
    <style>
	</style>
		
</head>
<body class="h-screen flex flex-col">
    <!-- Explorer Layout Template -->
<div class="w-full h-screen flex flex-col bg-white text-black select-none">

  <!-- ===== Top Toolbar ===== -->
  <div class="flex flex-wrap items-center gap-2 p-2 border-b bg-gray-50">
    <a th:href="@{/Dir/Index.html}">
      <img th:src="@{/images/favicon/favicon-96x96.png}" alt="Burrow Nest" class="w-8 h-8">
    </a>

    <!-- êµ¬ë¶„ì„  -->
    <div class="w-px h-6 bg-gray-400 mx-2"></div>

    <!-- í¸ì§‘ -->
    <button id="copyBtn"  class="px-2 py-1 bg-white border rounded hover:bg-gray-100">ğŸ“„ ë³µì‚¬</button>
    <button id="cutBtn"   class="px-2 py-1 bg-white border rounded hover:bg-gray-100">âœ‚ï¸ ìë¥´ê¸°</button>
    <button id="pasteBtn" class="px-2 py-1 bg-white border rounded hover:bg-gray-100" disabled>ğŸ“‹ ë¶™ì—¬ë„£ê¸°</button>

    <!-- êµ¬ë¶„ì„  -->
    <div class="w-px h-6 bg-gray-400 mx-2"></div>

    <!-- íŒŒì¼ -->
    <button id="uploadBtn"    class="px-2 py-1 bg-white border rounded hover:bg-gray-100">â¬†ï¸ ì—…ë¡œë“œ</button>
    <button id="downloadBtn"  class="px-2 py-1 bg-white border rounded hover:bg-gray-100">â¬‡ï¸ ë‹¤ìš´ë¡œë“œ</button>
    <button id="deleteBtn"    class="px-2 py-1 bg-white border rounded hover:bg-gray-100">ğŸ—‘ï¸ ì‚­ì œ</button>
    <button id="renameBtn"    class="px-2 py-1 bg-white border rounded hover:bg-gray-100">âœï¸ ì´ë¦„ ë³€ê²½</button>
    <button id="newFolderBtn" class="px-2 py-1 bg-white border rounded hover:bg-gray-100">ğŸ“â• ìƒˆ í´ë”</button>

    <!-- êµ¬ë¶„ì„  -->
    <div class="w-px h-6 bg-gray-400 mx-2"></div>

    <!-- ë³´ê¸° -->
    <button id="detailViewBtn" class="px-2 py-1 bg-white border rounded hover:bg-gray-100">ìƒì„¸ ë³´ê¸°</button>
    <button id="iconViewBtn"   class="px-2 py-1 bg-white border rounded hover:bg-gray-100">ì•„ì´ì½˜ ë³´ê¸°</button>

    <!-- êµ¬ë¶„ì„  -->
    <div class="w-px h-6 bg-gray-400 mx-2"></div>

    <!-- ê²€ìƒ‰ -->
    <div class="flex items-center gap-2">
      <label class="flex items-center gap-2 px-2 py-1 bg-white border rounded">
        <i class="fa-solid fa-magnifying-glass text-gray-500"></i>
        <input id="searchInputTop" type="text" placeholder="ê²€ìƒ‰" class="outline-none text-sm" />
      </label>
      <select id="searchScope" class="text-sm border rounded px-2 py-1">
        <option value="filter">í˜„ì¬ ëª©ë¡ í•„í„°</option>
        <option value="recursive">í•˜ìœ„ í´ë” í¬í•¨ ê²€ìƒ‰</option>
        <option value="all">ì „ì²´ ê²€ìƒ‰</option>
      </select>
      <select id="searchTarget" class="text-sm border rounded px-2 py-1">
        <option value="all">íŒŒì¼+í´ë”</option>
        <option value="file">íŒŒì¼ë§Œ</option>
        <option value="dir">í´ë”ë§Œ</option>
      </select>
    </div>
  </div>

  <!-- ===== Main Split (Left: Files / Right: Directory Tree) ===== -->
  <div class="flex flex-1 overflow-hidden">

    <!-- Left: File Area -->
    <section id="resizable-left"  class="flex-1 flex flex-col overflow-hidden">
      <!-- (ì„ íƒ) í˜„ì¬ ê²½ë¡œ í‘œì‹œ -->
      <div id="breadcrumb" class="px-3 py-2 text-xs text-gray-600 border-b truncate">Root</div>

      <!-- íŒŒì¼/í´ë” ëª©ë¡ -->
      <div class="flex-1 overflow-auto p-3">
        <div id="fileGrid" class="grid grid-cols-10 gap-4"><!-- items render here --></div>
      </div>
    </section>

    <!-- Right: Directory / Tree -->
    <aside class="w-80 border-l overflow-auto p-4">
      <div id="tree" class="bg-white rounded-lg font-mono text-sm" role="tree"><!-- tree render here --></div>
    </aside>
  </div>

  <!-- ===== Templates: File Items (Icon/Detail) ===== -->
  <!-- ì•„ì´ì½˜ ë³´ê¸°ìš© -->
  <template id="fileItemIconTemplate">
    <div class="file-item flex flex-col items-center p-2 border border-gray-200 rounded hover:bg-blue-50 cursor-pointer select-none">
      <div class="thumb w-16 h-16 bg-gray-100 rounded overflow-hidden not-italic flex items-center justify-center">
        <img class="thumb-img w-full h-full object-cover hidden" loading="lazy" />
        <i class="icon fa-solid text-gray-400 text-2xl"></i>
      </div>
      <div class="file-name text-xs text-center mt-2 truncate w-24"></div>
    </div>
  </template>

  <!-- ìƒì„¸ ë³´ê¸°ìš© (í–‰) -->
  <template id="fileItemDetailTemplate">
    <tr class="file-item select-none hover:bg-blue-50">
      <td class="border p-2 text-center w-10"><i class="icon fa-solid"></i></td>
      <td class="border p-2 text-left file-name"></td>
      <td class="border p-2 text-center file-date"></td>
      <td class="border p-2 text-center file-type"></td>
      <td class="border p-2 text-right file-size"></td>
    </tr>
  </template>

  <!-- ìƒì„¸ ë³´ê¸°ìš© (í…Œì´ë¸”) -->
  <template id="fileItemDetailTableTemplate">
    <table class="table-auto w-full border-collapse border border-gray-200 text-sm">
      <thead>
        <tr class="bg-gray-100 text-xs">
          <th class="border p-2 text-center w-10"></th>
          <th class="border p-2 text-left">ì´ë¦„</th>
          <th class="border p-2 text-center">ìˆ˜ì •ë‚ ì§œ</th>
          <th class="border p-2 text-center">ìœ í˜•</th>
          <th class="border p-2 text-right">í¬ê¸°</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </template>

  <!-- ===== Template: Tree Node ===== -->
  <template id="treeNodeTemplate">
    <li class="mb-1" role="treeitem">
      <div class="flex items-center space-x-1 cursor-pointer group" data-node="true">
        <svg class="chevron w-4 h-4 text-gray-500 transition-transform"
             viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 5l7 7-7 7"/>
        </svg>
        <svg class="folder-icon w-5 h-5 text-yellow-500" viewBox="0 0 20 20" fill="currentColor">
          <!-- ì•„ì´ì½˜ì€ JSì—ì„œ open/close êµì²´ -->
        </svg>
        <span class="folder-label"></span>
      </div>
    </li>
  </template>

  <!-- ===== Context Menus ===== -->
  <!-- 1) Folder (Tree) Context Menu â€” ê¸°ì¡´ ì†ŒìŠ¤ ì‚¬ìš© -->
  <ul id="contextMenuFolder" class="absolute hidden bg-white border border-gray-300 shadow-lg rounded-md w-56 text-sm z-50">
    <li class="flex items-center px-4 py-2 hover:bg-gray-100 cursor-pointer" data-action="open">
      <span class="mr-2">ğŸ“‚</span> ì—´ê¸°
    </li>
    <hr class="my-1 border-gray-200">

    <li class="flex items-center px-4 py-2 hover:bg-gray-100 cursor-pointer" data-action="cut">
      <span class="mr-2">âœ‚ï¸</span> ì˜ë¼ë‚´ê¸°
    </li>
    <li class="flex items-center px-4 py-2 hover:bg-gray-100 cursor-pointer" data-action="copy">
      <span class="mr-2">ğŸ“„</span> ë³µì‚¬
    </li>
    <li class="flex items-center px-4 py-2 hover:bg-gray-100 text-gray-400 cursor-not-allowed" data-action="paste">
      <span class="mr-2">ğŸ“‹</span> ë¶™ì—¬ë„£ê¸°
    </li>

    <li class="flex items-center px-4 py-2 hover:bg-gray-100 cursor-pointer" data-action="rename">
      <span class="mr-2">ğŸ“„</span> ì´ë¦„ë³€ê²½
    </li>

    <hr class="my-1 border-gray-200">

    <li class="flex items-center px-4 py-2 hover:bg-gray-100 cursor-pointer" data-action="detail">
      <span class="mr-2">âš™ï¸</span> ì†ì„±
    </li>
  </ul>

  <!-- 2) File Area Context Menu â€” í†µí•©(ì•„ì´í…œ/ë°°ê²½) -->
  <ul id="contextMenuFile"
      class="absolute hidden bg-white border border-gray-300 shadow-lg rounded-md w-56 text-sm z-50">
    <li class="px-4 py-2 text-gray-500 text-xs">íŒŒì¼ ë©”ë‰´</li>
    <hr class="my-1 border-gray-200">

    <li class="file-only flex items-center px-4 py-2 hover:bg-gray-100 cursor-pointer" data-action="open">
      <span class="mr-2">ğŸ“„</span> ì—´ê¸°
    </li>
    <li class="file-only flex items-center px-4 py-2 hover:bg-gray-100 cursor-pointer" data-action="download">
      <span class="mr-2">â¬‡ï¸</span> ë‹¤ìš´ë¡œë“œ
    </li>

    <li class="item-only flex items-center px-4 py-2 hover:bg-gray-100 cursor-pointer" data-action="rename">
      <span class="mr-2">âœï¸</span> ì´ë¦„ë³€ê²½
    </li>
    <li class="item-only flex items-center px-4 py-2 hover:bg-gray-100 cursor-pointer" data-action="delete">
      <span class="mr-2">ğŸ—‘ï¸</span> ì‚­ì œ
    </li>

    <hr class="my-1 border-gray-200">

    <li class="flex items-center px-4 py-2 hover:bg-gray-100 cursor-pointer" data-action="copy">
      <span class="mr-2">ğŸ“„</span> ë³µì‚¬
    </li>
    <li class="flex items-center px-4 py-2 hover:bg-gray-100 cursor-pointer" data-action="cut">
      <span class="mr-2">âœ‚ï¸</span> ìë¥´ê¸°
    </li>
    <li class="flex items-center px-4 py-2 hover:bg-gray-100 text-gray-400 cursor-not-allowed" data-action="paste">
      <span class="mr-2">ğŸ“‹</span> ë¶™ì—¬ë„£ê¸°
    </li>

    <hr class="my-1 border-gray-200">

    <li class="bg-only flex items-center px-4 py-2 hover:bg-gray-100 cursor-pointer" data-action="new-folder">
      <span class="mr-2">ğŸ“â•</span> ìƒˆ í´ë”
    </li>
    <li class="flex items-center px-4 py-2 hover:bg-gray-100 cursor-pointer" data-action="properties">
      <span class="mr-2">âš™ï¸</span> ì†ì„±
    </li>
  </ul>

  <!-- (ì„ íƒ) ì»¤ìŠ¤í…€ ìŠ¤í¬ë¦½íŠ¸/ì„œë¸Œë©”ë‰´ ì£¼ì… -->
  <th:script th:replace="~{Storage/StorageScript :: script}"/>
  <th:div th:replace="~{Storage/CustomSubMenu :: customMenu}"/>
</div>


    <!-- Footer -->
    <div th:replace="~{Storage/Footer :: footer}" class="flex-none border-t border-gray-300 text-sm px-2 py-1"></div>

    <!-- Optional: Add a simple resizable script -->
    <th:script th:replace="~{Common/Script :: script}"/>
    
    <script th:inline="javascript">
        const resizable = document.getElementById('resizable-left');
        
        let isResizing = false;

        resizable.addEventListener('mousedown', function(e) {
            if (e.offsetX > resizable.offsetWidth - 10) {
                isResizing = true;
                document.body.style.cursor = 'col-resize';
            }
        });

        document.addEventListener('mousemove', function(e) {
            if (!isResizing) return;
            const newWidth = e.clientX;
            resizable.style.width = newWidth + 'px';
        });

        document.addEventListener('mouseup', function() {
            isResizing = false;
            document.body.style.cursor = 'default';
        });
    </script>
    
    <!-- alert confirm prompt -->
	<div th:replace="~{Common/alertView :: alertView}"></div>
    <!-- ëª¨ë‹¬ì°½ -->
    <div th:replace="~{Common/modalView :: modalView}"></div>
    
    <th:script th:replace="~{Common/Script :: CommonScript}"/>
    
    <script th:inline="javascript">
/** =========================================================
 *  ì „ì—­ ê°€ì •(ì´ë¯¸ ì¡´ì¬):
 *   - storage: BnStorage ì¸ìŠ¤í„´ìŠ¤ (copy/cut/paste/selectDirectory/isClipboardAvailable ë“±)
 *   - loadFileList(uid): í˜„ì¬ í´ë” uidë¡œ íŒŒì¼ ë¦¬ìŠ¤íŠ¸ ë¡œë“œ
 *   - renderFileList(list): ìš°ì¸¡ ê·¸ë¦¬ë“œ ë Œë” (ë‚´ë¶€ì—ì„œ .file-item ìš”ì†Œ ìƒì„±)
 *   - #tree: íŠ¸ë¦¬ ë£¨íŠ¸, #fileGrid: íŒŒì¼ ê·¸ë¦¬ë“œ ë£¨íŠ¸
 *   - lastFetchedList: ìµœê·¼ ë¡œë“œ ëª©ë¡ ([{ uid, name, isFile, extension, fileLength, lastModified, ... }])
 *   - highlightTreeSelection(uid): íŠ¸ë¦¬ í•˜ì´ë¼ì´íŠ¸
 * ========================================================= */

(function() {
	const storage = new BnStorage();
  // ===== ì „ì—­ ìƒíƒœ/ìœ í‹¸ =====
  const fileGrid = document.getElementById('fileGrid');
  const tree = document.getElementById('tree');
  const menuFile = document.getElementById('contextMenuFile');
  const menuFolder = document.getElementById('contextMenuFolder'); // (ì¢Œì¸¡ íŠ¸ë¦¬ìš©, ê¸°ì¡´)
  const pasteBtn = document.getElementById('pasteBtn');

  // í˜„ì¬ í´ë” uid(ì¢Œì¸¡ onSelected í˜¸ì¶œ ì‹œ ì—…ë°ì´íŠ¸ ê¶Œì¥)
  window.currentFolderUid = window.currentFolderUid || '';

  // ê°„ë‹¨ ë””ë°”ìš´ìŠ¤
  function debounce(fn, wait = 250) {
    let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
  }

  // íŒŒì¼ ì˜ì—­ì—ì„œ ì„ íƒëœ í•­ëª© uid[]
  function getSelectedFileUids() {
    return Array.from(document.querySelectorAll('#fileGrid .file-item.bg-blue-100'))
      .map(el => el.dataset.uid)
      .filter(Boolean);
  }

  // uid -> item ë¹ ë¥¸ ì¡°íšŒ
  function getItemByUid(uid) {
    if (!Array.isArray(window.lastFetchedList)) return null;
    return window.lastFetchedList.find(x => x.uid === uid) || null;
  }

  // ì»¨í…ìŠ¤íŠ¸ ë§Œë“¤ê¸°
  function buildContext(overrides = {}) {
    const selectionUids = getSelectedFileUids();
    const selection = selectionUids.map(getItemByUid).filter(Boolean);
    const destinationUid = overrides.destinationUid ?? window.currentFolderUid;
    const target = overrides.target || null; // ë‹¨ì¼ íƒ€ê²Ÿ(ì•„ì´í…œ ìš°í´ë¦­ ë“±)
    return {
      selectionUids,
      selection,
      destinationUid,
      target,
      hasClipboard: !!storage?.isClipboardAvailable?.(),
      currentFolderUid: window.currentFolderUid
    };
  }

  // ===== ì»¤ë§¨ë“œ ë ˆì§€ìŠ¤íŠ¸ë¦¬ =====
  const commands = {
    copy: {
      canExecute(ctx){ return ctx.selection.length > 0; },
      run(ctx){ storage?.copyItems ? storage.copyItems(ctx.selection) : storage?.copyDirectory?.(); }
    },
    cut: {
      canExecute(ctx){ return ctx.selection.length > 0; },
      run(ctx){ storage?.cutItems ? storage.cutItems(ctx.selection) : storage?.cutDirectory?.(); }
    },
    paste: {
      canExecute(ctx){ return ctx.hasClipboard && !!ctx.destinationUid; },
      async run(ctx){
        await storage?.pasteDirectory?.(ctx.destinationUid);
        // storage?.clearClipboard?.(); // ì •ì±…ì— ë”°ë¼ ìœ ì§€/ì‚­ì œ ì„ íƒ
        refreshPasteEnabled();
        loadFileList(ctx.destinationUid);
      }
    },
    delete: {
      canExecute(ctx){ return ctx.selection.length > 0; },
      async run(ctx){
        if (!confirm(`${ctx.selection.length}ê°œ í•­ëª©ì„ ì‚­ì œí• ê¹Œìš”?`)) return;
        if (storage?.deleteItems) await storage.deleteItems(ctx.selection);
        loadFileList(ctx.currentFolderUid);
      }
    },
    rename: {
      canExecute(ctx){ return ctx.selection.length === 1; },
      async run(ctx){
        const item = ctx.selection[0];
        const next = prompt('ìƒˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', item?.name ?? '');
        if (!next || next === item.name) return;
        if (item.isFile) {
          if (storage?.renameFile) await storage.renameFile(item.uid, next);
        } else {
          if (storage?.renameDirectory) await storage.renameDirectory(item.uid, next);
        }
        loadFileList(ctx.currentFolderUid);
      }
    },
    newFolder: {
      canExecute(ctx){ return !!ctx.destinationUid; },
      async run(ctx){
        const name = prompt('ìƒˆ í´ë” ì´ë¦„', 'ìƒˆ í´ë”');
        if (!name) return;
        if (storage?.createDirectory) await storage.createDirectory(ctx.destinationUid, name);
        loadFileList(ctx.destinationUid);
      }
    },
    download: {
      canExecute(ctx){ return ctx.selection.length >= 1; },
      run(ctx){
        // ë‹¨ì¼/ë³µìˆ˜ ëª¨ë‘ ì²˜ë¦¬(ë³µìˆ˜ëŠ” ì„œë²„ì—ì„œ zip ë“±ìœ¼ë¡œ ì²˜ë¦¬)
        if (storage?.downloadItems) storage.downloadItems(ctx.selection);
        else {
          // fallback: ë‹¨ì¼ íŒŒì¼ ìƒˆ ì°½
          ctx.selection.forEach(it => {
            if (it.isFile) {
              const FILE_OPEN_URL  = /*[[@{/Files/Open/}]]*/ '/Files/Open/';
              window.open(`${FILE_OPEN_URL}${encodeURIComponent(it.uid)}`, '_blank');
            }
          });
        }
      }
    },
    open: {
      canExecute(ctx){ return !!ctx.target; },
      run(ctx){
        const it = ctx.target;
        if (it.isFile) {
          const FILE_OPEN_URL  = /*[[@{/Files/Open/}]]*/ '/Files/Open/';
          window.open(`${FILE_OPEN_URL}${encodeURIComponent(it.uid)}`, '_blank');
        } else {
          // í´ë” ì´ë™
          window.currentFolderUid = it.uid;
          loadFileList(it.uid);
          highlightTreeSelection?.(it.uid);
        }
      }
    },
    properties: {
      canExecute(ctx){ return (ctx.selection.length === 1) || !!ctx.target || !!ctx.destinationUid; },
      run(ctx){
        const it = ctx.selection[0] || ctx.target || { name: '(í˜„ì¬ í´ë”)', uid: ctx.destinationUid };
        alert([
          `ì´ë¦„: ${it.name ?? ''}`,
          `UID: ${it.uid ?? ''}`,
          `ìœ í˜•: ${it.isFile ? 'íŒŒì¼' : 'í´ë”'}`
        ].join('\n'));
      }
    },
    upload: {
      canExecute(ctx){ return !!ctx.destinationUid; },
      run(ctx){
        if (storage?.uploadTo) storage.uploadTo(ctx.destinationUid);
        else alert('ì—…ë¡œë“œ ê¸°ëŠ¥ì€ êµ¬í˜„ ëŒ€ìƒì…ë‹ˆë‹¤.');
      }
    },
    // ê²€ìƒ‰(ìƒë‹¨ ê²€ìƒ‰ì°½ê³¼ ì—°ê²°)
    search: {
      canExecute(){ return true; },
      run({ query, scope, target }){
        // 1) í´ë¼ì´ì–¸íŠ¸ í•„í„° ëª¨ë“œ(í˜„ì¬ ëª©ë¡)
        if (scope === 'filter') {
          // ì˜¤ë¥¸ìª½ ì˜ì—­ì— searchInputì´ ì´ë¯¸ ìˆë‹¤ë©´ ì´ë²¤íŠ¸ë§Œ ì „ë‹¬
          const sink = document.getElementById('searchInput') || document.getElementById('searchInputTop');
          if (sink) {
            sink.value = query || '';
            sink.dispatchEvent(new Event('input', { bubbles: true }));
          }
          return;
        }
        // 2) ì„œë²„ ê²€ìƒ‰ (ì¬ê·€/ì „ì²´)
        const url = /*[[@{/Dir/Search.json}]]*/ '/Dir/Search.json'; // êµ¬í˜„ ì‹œ ì„œë²„ APIì— ë§ì¶° êµì²´
        const params = new URLSearchParams({
          q: query || '',
          scope: scope,     // recursive | all
          target: target,   // all | file | dir
          base: window.currentFolderUid || ''
        });
        fetch(`${url}?${params.toString()}`)
          .then(r => r.json())
          .then(list => {
            window.lastFetchedList = Array.isArray(list) ? list : [];
            renderFileList(window.lastFetchedList);
          })
          .catch(err => console.error('search error', err));
      }
    }
  };

  // ===== íˆ´ë°” ë°”ì¸ë”© =====
  function refreshPasteEnabled() {
    const ctx = buildContext();
    const enabled = commands.paste.canExecute(ctx);
    if (pasteBtn) pasteBtn.disabled = !enabled;
    // íŒŒì¼ ì˜ì—­ ìš°í´ë¦­ ë©”ë‰´ì˜ ë¶™ì—¬ë„£ê¸° í•­ëª©ì€ ì—´ ë•Œë§ˆë‹¤ ê°±ì‹ 
  }

  document.getElementById('copyBtn')?.addEventListener('click', () => {
    const ctx = buildContext(); if (commands.copy.canExecute(ctx)) commands.copy.run(ctx);
  });
  document.getElementById('cutBtn')?.addEventListener('click', () => {
    const ctx = buildContext(); if (commands.cut.canExecute(ctx)) commands.cut.run(ctx);
    refreshPasteEnabled();
  });
  document.getElementById('pasteBtn')?.addEventListener('click', () => {
    const ctx = buildContext(); if (commands.paste.canExecute(ctx)) commands.paste.run(ctx);
  });

  document.getElementById('deleteBtn')?.addEventListener('click', () => {
    const ctx = buildContext(); if (commands.delete.canExecute(ctx)) commands.delete.run(ctx);
  });
  document.getElementById('renameBtn')?.addEventListener('click', () => {
    const ctx = buildContext(); if (commands.rename.canExecute(ctx)) commands.rename.run(ctx);
  });
  document.getElementById('downloadBtn')?.addEventListener('click', () => {
    const ctx = buildContext(); if (commands.download.canExecute(ctx)) commands.download.run(ctx);
  });
  document.getElementById('newFolderBtn')?.addEventListener('click', () => {
    const ctx = buildContext(); if (commands.newFolder.canExecute(ctx)) commands.newFolder.run(ctx);
  });
  document.getElementById('uploadBtn')?.addEventListener('click', () => {
    const ctx = buildContext(); if (commands.upload.canExecute(ctx)) commands.upload.run(ctx);
  });

  // ===== ê²€ìƒ‰ ë°”ì¸ë”© =====
  const searchInputTop = document.getElementById('searchInputTop');
  const searchScope = document.getElementById('searchScope');
  const searchTarget = document.getElementById('searchTarget');

  const fireSearch = debounce(() => {
    const query = searchInputTop?.value ?? '';
    const scope = searchScope?.value ?? 'filter';
    const target = searchTarget?.value ?? 'all';
    commands.search.run({ query, scope, target });
  }, 300);

  searchInputTop?.addEventListener('input', fireSearch);
  searchScope?.addEventListener('change', fireSearch);
  searchTarget?.addEventListener('change', fireSearch);

  // ë‹¨ì¶•í‚¤: Ctrl/Cmd+F í¬ì»¤ìŠ¤
  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'f') {
      e.preventDefault();
      searchInputTop?.focus();
      searchInputTop?.select();
    }
  });

  // ===== íŒŒì¼ ì˜ì—­ ìš°í´ë¦­ ë©”ë‰´ =====
  let ctxTargetItem = null; // ì•„ì´í…œ ìš°í´ë¦­ ì‹œ ëŒ€ìƒ

  function hideContextMenu(menu) {
    menu.classList.add('hidden');
  }
  function placeMenu(menu, x, y) {
    menu.style.position = 'fixed';
    const vw = window.innerWidth, vh = window.innerHeight;
    // ë¨¼ì € ë³´ì´ê²Œ í•´ì„œ í¬ê¸° ê³„ì‚°
    menu.classList.remove('hidden');
    const rect = menu.getBoundingClientRect();
    let left = x, top = y;
    if (left + rect.width > vw) left = Math.max(0, vw - rect.width - 2);
    if (top + rect.height > vh) top = Math.max(0, vh - rect.height - 2);
    menu.style.left = left + 'px';
    menu.style.top = top + 'px';
  }
  function updateFileMenuState({ isBackground, isFolderItem, hasSelection }) {
    // ë¶™ì—¬ë„£ê¸° í™œì„±í™”
    const pasteLi = menuFile.querySelector('[data-action="paste"]');
    const canPaste = storage?.isClipboardAvailable?.();
    pasteLi.classList.toggle('text-gray-400', !canPaste);
    pasteLi.classList.toggle('cursor-not-allowed', !canPaste);
    pasteLi.classList.toggle('cursor-pointer', !!canPaste);

    // ì•„ì´í…œ ì „ìš©/ë°°ê²½ ì „ìš© í‘œì‹œ
    menuFile.querySelectorAll('.file-only,.item-only,.bg-only').forEach(el => el.classList.remove('hidden'));
    // ë°°ê²½ í´ë¦­: item-only ìˆ¨ê¹€, open/download ìˆ¨ê¹€, new-folder í‘œì‹œ
    if (isBackground) {
      menuFile.querySelectorAll('.item-only,.file-only').forEach(el => el.classList.add('hidden'));
      menuFile.querySelectorAll('.bg-only').forEach(el => el.classList.remove('hidden'));
    } else {
      menuFile.querySelectorAll('.bg-only').forEach(el => el.classList.add('hidden'));
      // í´ë” ì•„ì´í…œì¼ ë•Œ open ê°€ëŠ¥ / íŒŒì¼ì¼ ë•Œ open+download ê°€ëŠ¥
      if (!isFolderItem) {
        // íŒŒì¼ì´ ì•„ë‹Œë° file-only ë³´ì´ëŠ” ê±´ ìœ ì§€(ë‹¤ìš´ë¡œë“œ/ì—´ê¸°)
      }
      // ë‹¤ì¤‘ ì„ íƒ ì‹œ: rename/openì€ ë¹„í™œì„±í™”í•˜ëŠ” ëŒ€ì‹  ìˆ¨ê¹€
      if (!hasSelection || getSelectedFileUids().length !== 1) {
        menuFile.querySelector('[data-action="rename"]')?.classList.add('hidden');
        menuFile.querySelector('[data-action="open"]')?.classList.add('hidden');
        menuFile.querySelector('[data-action="download"]')?.classList.remove('hidden'); // ë³µìˆ˜ ë‹¤ìš´ë¡œë“œ í—ˆìš© ì‹œ í‘œì‹œ ìœ ì§€
      }
    }
  }

  fileGrid?.addEventListener('contextmenu', (e) => {
    const itemEl = e.target.closest('.file-item');
    ctxTargetItem = null;

    // ë°°ê²½ or ì•„ì´í…œ
    const isBackground = !itemEl;
    const item = isBackground ? null : getItemByUid(itemEl.dataset.uid);

    // ì„ íƒ ì‹±í¬: ì•„ì´í…œ ìš°í´ë¦­ì¸ë° ì„ íƒì— ì—†ë‹¤ë©´ ê·¸ ì•„ì´í…œë§Œ ë‹¨ì¼ ì„ íƒìœ¼ë¡œ
    if (itemEl) {
      const alreadySelected = itemEl.classList.contains('bg-blue-100');
      if (!alreadySelected) {
        // ê¸°ì¡´ ì„ íƒ í•´ì œ í›„ ë‹¨ì¼ ì„ íƒ
        document.querySelectorAll('#fileGrid .file-item.bg-blue-100').forEach(el => el.classList.remove('bg-blue-100'));
        itemEl.classList.add('bg-blue-100');
      }
      ctxTargetItem = item;
    }

    e.preventDefault();
    placeMenu(menuFile, e.clientX, e.clientY);
    updateFileMenuState({
      isBackground,
      isFolderItem: !!item && !item.isFile,
      hasSelection: getSelectedFileUids().length > 0
    });
  });

  // íŒŒì¼ ë©”ë‰´ í´ë¦­ ì²˜ë¦¬
  menuFile.addEventListener('click', async (e) => {
    const li = e.target.closest('li[data-action]');
    if (!li) return;
    const action = li.dataset.action;

    // ë¹„í™œì„± ë¶™ì—¬ë„£ê¸° ë°©ì§€
    if (action === 'paste' && (li.classList.contains('text-gray-400') || li.classList.contains('cursor-not-allowed'))) {
      return;
    }
    hideContextMenu(menuFile);

    const baseCtx = buildContext({ target: ctxTargetItem });
    switch (action) {
      case 'open':        if (commands.open.canExecute(baseCtx)) commands.open.run(baseCtx); break;
      case 'download':    if (commands.download.canExecute(baseCtx)) commands.download.run(baseCtx); break;
      case 'rename':      if (commands.rename.canExecute(baseCtx)) commands.rename.run(baseCtx); break;
      case 'delete':      if (commands.delete.canExecute(baseCtx)) commands.delete.run(baseCtx); break;
      case 'copy':        if (commands.copy.canExecute(baseCtx)) commands.copy.run(baseCtx); refreshPasteEnabled(); break;
      case 'cut':         if (commands.cut.canExecute(baseCtx)) commands.cut.run(baseCtx);  refreshPasteEnabled(); break;
      case 'paste':       if (commands.paste.canExecute(baseCtx)) commands.paste.run(baseCtx); break;
      case 'new-folder':  if (commands.newFolder.canExecute(baseCtx)) commands.newFolder.run(baseCtx); break;
      case 'properties':  if (commands.properties.canExecute(baseCtx)) commands.properties.run(baseCtx); break;
    }
    ctxTargetItem = null;
  });

  // ë°”ê¹¥ í´ë¦­/ESC/ìŠ¤í¬ë¡¤ë¡œ ë‹«ê¸°
  document.addEventListener('click', (e) => {
    if (!menuFile.classList.contains('hidden') && !menuFile.contains(e.target)) hideContextMenu(menuFile);
  }, true);
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (!menuFile.classList.contains('hidden')) hideContextMenu(menuFile);
      if (!menuFolder.classList.contains('hidden')) hideContextMenu(menuFolder);
    }
  }, true);
  document.addEventListener('scroll', () => {
    if (!menuFile.classList.contains('hidden')) hideContextMenu(menuFile);
  }, true);

  // ===== ì¢Œì¸¡ íŠ¸ë¦¬ onSelected í›…ì„ í•œ ì¤„ë§Œ ë³´ê°• (í˜„ì¬ í´ë” ë™ê¸°í™”) =====
  // onSelected(node) ë‚´ë¶€(ì¢Œì¸¡ ì½”ë“œ)ì— ì•„ë˜ í•œ ì¤„ë§Œ ì¶”ê°€í•˜ë©´, ë¶™ì—¬ë„£ê¸°/ê²€ìƒ‰ì˜ ëª©ì ì§€ ë™ì‘ì´ ì •í™•í•´ì§‘ë‹ˆë‹¤.
  // window.currentFolderUid = node.owner.uid;

  // ===== ì´ˆê¸° ì§„ì… ì‹œ ë¶™ì—¬ë„£ê¸° ë²„íŠ¼ ìƒíƒœ ê°±ì‹  =====
  refreshPasteEnabled();

})();
</script>
    
    
</body>
</html>
