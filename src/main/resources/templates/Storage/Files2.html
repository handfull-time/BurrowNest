<div xmlns:th="http://www.thymeleaf.org" th:fragment="files"
     class="p-2 text-sm bg-white text-black select-none h-full w-full overflow-hidden">

  <!-- ìƒë‹¨ íˆ´ë°” -->
  <div class="flex justify-between items-center mb-3">
    <label class="inline-flex items-center">
      <input type="checkbox" id="selectAll" class="form-checkbox">
      <span class="ml-2">ì „ì²´ ì„ íƒ</span>
    </label>

    <div class="flex items-center gap-2">
      <button id="iconViewBtn" class="px-2 py-1 bg-gray-200 rounded">ğŸ”³ ì•„ì´ì½˜ ë³´ê¸°</button>
      <button id="listViewBtn" class="px-2 py-1 bg-blue-500 text-white rounded">ğŸ“„ ë¦¬ìŠ¤íŠ¸ ë³´ê¸°</button>
      <label class="inline-flex items-center">
        <input type="checkbox" id="toggleDetail" class="form-checkbox">
        <span class="ml-2">ìƒì„¸ ë³´ê¸°</span>
      </label>
    </div>
  </div>

  <!-- ë©”ì¸ ì½˜í…ì¸  (íŒŒì¼ ëª©ë¡ + ìƒì„¸ë³´ê¸° ì‚¬ì´ë“œë°”) -->
  <div class="flex h-full">

    <!-- ğŸ“ íŒŒì¼ ëª©ë¡ ì˜ì—­ -->
    <div id="fileArea" class="flex-1 overflow-auto pr-2">
      
      <!-- ì•„ì´ì½˜ ë·° -->
      <div id="iconView" class="grid grid-cols-5 gap-4 hidden"></div>

      <!-- ë¦¬ìŠ¤íŠ¸ ë·° -->
      <table id="listView" class="min-w-full text-left border border-gray-300">
        <thead class="bg-gray-100 text-base text-center font-semibold">
          <tr>
            <th class="px-3 py-2 w-10"></th>
            <th class="px-3 py-2">íŒŒì¼ëª…</th>
            <th class="px-3 py-2">ìœ í˜•</th>
            <th class="px-3 py-2">í¬ê¸°</th>
            <th class="px-3 py-2">ìˆ˜ì •ì¼</th>
          </tr>
        </thead>
        <tbody id="listViewBody"></tbody>
      </table>
    </div>

    <!-- â„¹ï¸ ìƒì„¸ë³´ê¸° ì‚¬ì´ë“œë°” -->
    <div id="detailsPanel"
         class="w-[100px] h-full border-l border-gray-200 bg-gray-50 px-2 py-2 hidden flex-shrink-0">
      <h4 class="font-bold mb-1 text-xs">ìƒì„¸</h4>
      <div id="detailsContent" class="text-[11px] text-gray-700 leading-tight">
        ì„ íƒëœ í•­ëª© ì—†ìŒ
      </div>
    </div>

  </div>

  <!-- ğŸ”½ íŒŒì¼ ëª©ë¡ JavaScriptì— ì£¼ì… -->
  <script th:inline="javascript">
    const fileList = /*[[${files}]]*/ [];

    document.addEventListener("DOMContentLoaded", () => {
      const iconView = document.getElementById("iconView");
      const listView = document.getElementById("listView");
      const listViewBody = document.getElementById("listViewBody");
      const iconBtn = document.getElementById("iconViewBtn");
      const listBtn = document.getElementById("listViewBtn");
      const detailToggle = document.getElementById("toggleDetail");
      const detailPanel = document.getElementById("detailsPanel");
      const detailsContent = document.getElementById("detailsContent");
      const selectAll = document.getElementById("selectAll");

      const renderListView = () => {
        listViewBody.innerHTML = "";
        fileList.forEach((file, i) => {
          const tr = document.createElement("tr");
          tr.className = "hover:bg-gray-50 cursor-pointer file-list-item";
          tr.dataset.index = i;

          tr.innerHTML = `
            <td class="px-3 py-2"><input type="checkbox" class="file-checkbox" data-index="${i}"/></td>
            <td class="px-3 py-2">${file.name}</td>
            <td class="px-3 py-2">${file.directory ? '' : file.contentType}</td>
            <td class="px-3 py-2">${file.directory ? '' : file.size.toLocaleString() + ' bytes'}</td>
            <td class="px-3 py-2">${file.lastModified}</td>
          `;
          listViewBody.appendChild(tr);
        });
      };

      const renderIconView = () => {
        iconView.innerHTML = "";
        fileList.forEach((file, i) => {
          const div = document.createElement("div");
          div.className = "border p-2 rounded relative cursor-pointer file-icon-item hover:bg-gray-100";
          div.dataset.index = i;
          div.innerHTML = `
            <input type="checkbox" class="absolute top-1 left-1 z-10 file-checkbox" data-index="${i}" />
            <div class="flex flex-col items-center text-center">
              <div class="w-16 h-16 bg-gray-100 rounded flex items-center justify-center mb-2">
                ${file.contentType.startsWith("image/") ?
                  `<img src="/File/Open?path=${encodeURIComponent(file.name)}" class="w-full h-full object-cover rounded" />` :
                  `<span class="text-xl">ğŸ“„</span>`
                }
              </div>
              <span class="truncate w-full">${file.name}</span>
            </div>
          `;
          iconView.appendChild(div);
        });
      };

      const updateDetails = (index) => {
        const file = fileList[index];
        if (!file) return;

        detailsContent.innerHTML = `
          <div><strong>íŒŒì¼ëª…:</strong> ${file.name}</div>
          <div><strong>ìœ í˜•:</strong> ${file.contentType}</div>
          <div><strong>í¬ê¸°:</strong> ${file.size.toLocaleString()} bytes</div>
          <div><strong>ìˆ˜ì •ì¼:</strong> ${file.lastModified}</div>
        `;
      };

      iconBtn.addEventListener("click", () => {
        iconView.classList.remove("hidden");
        listView.classList.add("hidden");
        iconBtn.classList.add("bg-blue-500", "text-white");
        listBtn.classList.remove("bg-blue-500", "text-white");
      });

      listBtn.addEventListener("click", () => {
        listView.classList.remove("hidden");
        iconView.classList.add("hidden");
        listBtn.classList.add("bg-blue-500", "text-white");
        iconBtn.classList.remove("bg-blue-500", "text-white");
      });

      detailToggle.addEventListener("change", () => {
        detailPanel.classList.toggle("hidden", !detailToggle.checked);
      });

      selectAll.addEventListener("change", () => {
        document.querySelectorAll(".file-checkbox").forEach(cb => {
          cb.checked = selectAll.checked;
        });
      });

      // ì „ì²´ í´ë¦­ í•¸ë“¤ë§
      document.addEventListener("click", (e) => {
        const item = e.target.closest(".file-list-item, .file-icon-item");
        if (item) {
          const index = item.dataset.index;
          updateDetails(index);
        }
      });

      // ì´ˆê¸° ë Œë”ë§
      renderListView();
      renderIconView();
    });
    
 	// ë”ë¸” í´ë¦­: í´ë”ë©´ ì´ë™
    document.addEventListener("dblclick", (e) => {
      const item = e.target.closest(".file-list-item, .file-icon-item");
      if (!item) return;

      const index = item.dataset.index;
      const file = fileList[index];
      if (!file) return;

      const basePath = /*[[${path}]]*/ null;

      if (file.directory) {
        // í´ë”ì¼ ê²½ìš° ê²½ë¡œ ì´ë™
        const url = /*[[@{/Dir/Path.html}]]*/ null;
        
        let pathUrl = basePath.endsWith("/") ? basePath : basePath + "/";
        pathUrl += file.name;
        
        // ì¤‘ë³µëœ ìŠ¬ë˜ì‹œ ì œê±° (ì˜ˆ: // -> /)
        pathUrl = pathUrl.replace(/\/{2,}/g, "/");

        window.location.href =`${url}?path=${encodeURIComponent(pathUrl)}`;
      }else{
    	// ğŸ“„ íŒŒì¼ â†’ ë¸Œë¼ìš°ì €ì—ì„œ ì—´ê¸°
    	const openUrl = /*[[@{/File/Open}]]*/ null;
    	const fullPath = `${basePath.replace(/\/$/, "")}/${file.name}`.replace(/\/{2,}/g, "/");
    	window.open(`${openUrl}?path=${encodeURIComponent(fullPath)}`, '_blank');
      }
    });

    
    document.getElementById("downloadBtn").addEventListener("click", () => {
   	  const checked = Array.from(document.querySelectorAll(".file-checkbox:checked"));
   	  if (checked.length === 0) {
   	    alert("ë‹¤ìš´ë¡œë“œí•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.");
   	    return;
   	  }
   	  
   	  const selectedItems = checked.map(el => fileList[el.dataset.index]);
   	  const basePath = /*[[${path}]]*/ null;

   	  const hasFolder = selectedItems.some(f => f.directory);

   	  if (hasFolder) {
   	    // í´ë” í¬í•¨ â†’ ì••ì¶• ë‹¤ìš´ë¡œë“œ
   	    const paths = selectedItems.map(f => `${basePath}/${f.name}`.replace(/\/{2,}/g, "/"));
   	    const url = /*[[@{/File/ZipDownload}]]*/ null;
   	    const fullUrl = `${url}?paths=${encodeURIComponent(JSON.stringify(paths))}`;
   	    window.location.href = fullUrl;
   	  } else {
   	    // íŒŒì¼ë§Œ â†’ ê°œë³„ ë‹¤ìš´ë¡œë“œ
   	    const url = /*[[@{/File/Download}]]*/ null;
   	    selectedItems.forEach(file => {
   	      const fullPath = `${basePath}/${file.name}`.replace(/\/{2,}/g, "/");
   	      const link = document.createElement("a");
   	      link.href = `${url}?path=${encodeURIComponent(fullPath)}`;
   	      link.download = file.name;
   	      document.body.appendChild(link);
   	      link.click();
   	      document.body.removeChild(link);
   	    });
   	  }
   	});

    const pasteBtn = document.getElementById("pasteBtn");

    // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ í‚¤
    const STORAGE_KEY = "burrowClipboard";

    // ì„ íƒëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    function getSelectedFiles() {
      return Array.from(document.querySelectorAll(".file-checkbox:checked"))
        .map(cb => fileList[cb.dataset.index]);
    }

    // ì„¸ì…˜ì— ë³µì‚¬/ìë¥´ê¸° ì •ë³´ ì €ì¥
    function storeClipboard(operation, items) {
      
      const basePath = /*[[${path}]]*/ null;
      const payload = {
        type: operation, // 'copy' or 'cut'
        path: basePath,
        items
      };
      
      sessionStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      
      updatePasteButton();
    }

    // ë¶™ì—¬ë„£ê¸° ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
    function updatePasteButton() {
      const hasData = sessionStorage.getItem(STORAGE_KEY) !== null;
      
      if (hasData) {
    	  pasteBtn.disabled = false;
    	  pasteBtn.classList.remove("bg-gray-200", "text-gray-400", "cursor-not-allowed", "hover:bg-gray-200");
    	  pasteBtn.classList.add("bg-white", "text-black", "cursor-pointer", "hover:bg-gray-100");
	  } else {
    	  pasteBtn.disabled = true;
    	  pasteBtn.classList.add("bg-gray-200", "text-gray-400", "cursor-not-allowed", "hover:bg-gray-200");
    	  pasteBtn.classList.remove("bg-white", "text-black", "cursor-pointer", "hover:bg-gray-100");
      }
    }

    // ì´ˆê¸° ìƒíƒœ í™•ì¸
    updatePasteButton();

    document.getElementById("copyBtn").addEventListener("click", () => {
      const selected = getSelectedFiles();
      if (selected.length === 0) {
        alert("ë³µì‚¬í•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }
      storeClipboard("copy", selected);
    });

    document.getElementById("cutBtn").addEventListener("click", () => {
      const selected = getSelectedFiles();
      if (selected.length === 0) {
        alert("ìë¥´ê¸°í•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }
      storeClipboard("cut", selected);
    });

    pasteBtn.addEventListener("click", async () => {
      const data = sessionStorage.getItem(STORAGE_KEY);
      if (!data) {
        alert("ë¶™ì—¬ë„£ê¸°í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const { type, path: fromPath, items } = JSON.parse(data);
      const toPath = /*[[${path}]]*/ null;

      try {
        const res = await fetch(/*[[@{/File/Paste.json}]]*/ null, {
          method: "POST",
          credentials: "include", // ì¿ í‚¤ í¬í•¨
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ type, fromPath, toPath, items })
        });

        const result = await res.json();
        if (result.code === "0") {
          alert("ë¶™ì—¬ë„£ê¸° ì™„ë£Œ");
          sessionStorage.removeItem(STORAGE_KEY);
          updatePasteButton();
          location.reload();
        } else {
          alert("ë¶™ì—¬ë„£ê¸° ì‹¤íŒ¨: " + result.message);
        }
      } catch (e) {
        console.error("ë¶™ì—¬ë„£ê¸° ì˜¤ë¥˜", e);
        alert("ë¶™ì—¬ë„£ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    });
    
    document.getElementById("deleteBtn").addEventListener("click", async () => {

    	const targets = getSelectedFiles();
    	  if (targets.length === 0) {
      	    alert("ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
      	    return;
      	  }

    	  let confirmMessage = "";
    	  if (targets.length === 1) {
    	    confirmMessage = `'${targets[0].name}' íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
    	  } else {
    	    confirmMessage = `'${targets[0].name}' ì™¸ ${targets.length - 1}ê°œ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
    	  }

    	  if (!confirm(confirmMessage)) return;
    	  
    	  const path = /*[[${path}]]*/ null;
    	  
    	  console.info( JSON.stringify(targets.map(file => ({
    	      name: file.name,
    	      isDirectory: file.directory
    	    })) ));
    	  
    	  const url = /*[[@{/File/Delete.json}]]*/ null;

    	  const response = await fetch( url + `?path=${encodeURIComponent(path)}`, {
    	    method: "POST",
    	    credentials: "include", // ì¿ í‚¤ í¬í•¨
    	    headers: {
    	      "Content-Type": "application/json"
    	    },
    	    body: JSON.stringify(targets.map(file => ({
    	      name: file.name,
    	      isDirectory: file.directory
    	    })))
    	  });

    	  if (response.ok) {
    	    const result = await response.json();
    	    if (result.code === "0" ) {
    	      alert("ì‚­ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    	      window.location.reload();
    	    } else {
    	      alert("ì‚­ì œ ì‹¤íŒ¨: " + result.message);
    	    }
    	  } else {
    	    alert("ì„œë²„ ìš”ì²­ ì‹¤íŒ¨");
    	  }
    	});

  </script>
</div>
