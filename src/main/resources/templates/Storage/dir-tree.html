<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>ğŸ‡ BurrowNest</title>
    <meta charset="UTF-8">

   	<th:block th:replace="~{Common/Favicon :: Favicon}"></th:block>

    <script type="text/javascript" th:src="@{/js/tailwind/tailwind.min.js}"></script>
    
    <style>
	</style>
		
</head>
<body class="h-screen flex flex-col">
	<div class="p-2 text-sm">
	  <!-- ì¢Œì¸¡ íŠ¸ë¦¬ -->
	  <ul id="tree" class="list-disc pl-4" role="tree"></ul>

	  <script th:inline="javascript">
	  // ---- ìµœì†Œ ìœ í‹¸ ----
	  const API = (uid) => `/Burrow/Test/List.json?uid=${encodeURIComponent(uid||'')}`;

	  // ì„œë²„ ì‘ë‹µ: ë°°ì—´ ë˜ëŠ” {childs:[...]} ë‘˜ ë‹¤ í—ˆìš©
	  const parseChildren = (data) => Array.isArray(data) ? data : (data && Array.isArray(data.childs) ? data.childs : []);

	  // li ìƒì„±(í…ìŠ¤íŠ¸ë§Œ, í´ë¦­ ì‹œ OnSelected í˜¸ì¶œ)
	  function makeItem(node){
	    const li = document.createElement('li');
	    li.dataset.uid = node.uid;

	    const btn = document.createElement('button');
	    btn.type = 'button';
	    btn.textContent = node.name || '(ì´ë¦„ ì—†ìŒ)';
	    btn.className = 'hover:underline';
	    btn.addEventListener('click', (e) => {
	      e.stopPropagation();
	      OnSelected(node);
	    });

	    li.appendChild(btn);
	    return li;
	  }

	  // í•˜ìœ„ ëª©ë¡ ê·¸ë¦¬ê¸°: li ë°”ë¡œ ì•„ë˜ì— <ul> í•˜ë‚˜ ë§Œë“¤ì–´ì„œ ê°ˆì•„ë¼ì›€
	  function renderChildrenUnder(li, children){
	    let ul = li.querySelector(':scope > ul');
	    if (!ul) {
	      ul = document.createElement('ul');
	      ul.className = 'list-disc pl-4';
	      li.appendChild(ul);
	    }
	    ul.textContent = ''; // ì´ì „ ë‚´ìš© ì œê±°

	    if (!children.length) {
	      const empty = document.createElement('li');
	      empty.textContent = '(ë¹ˆ í´ë”)';
	      empty.className = 'text-gray-500';
	      ul.appendChild(empty);
	      return;
	    }
	    for (const ch of children) ul.appendChild(makeItem(ch));
	  }

	  // ìš”êµ¬ì‚¬í•­ í•¨ìˆ˜: OnSelected(node) â€” APIë§Œ í˜¸ì¶œí•´ì„œ í•˜ìœ„ ulì„ ë‹¤ì‹œ ê·¸ë¦¼
	  async function OnSelected(node){
	    const uid = node?.uid || node?.owner?.uid || '';
	    const li = document.querySelector(`li[data-uid="${CSS.escape(uid)}"]`);
	    if (!uid || !li) return;

	    try {
	      const res = await fetch(API(uid), { cache: 'no-store' });
	      if (!res.ok) throw new Error('dir list fetch failed');
	      const data = await res.json();
	      const children = parseChildren(data);
	      renderChildrenUnder(li, children);
	    } catch (e) {
	      console.error(e);
	      // ê°„ë‹¨ ì—ëŸ¬ í‘œê¸°
	      renderChildrenUnder(li, []);
	      li.querySelector(':scope > ul > li')?.replaceChildren(document.createTextNode('(ë¡œë“œ ì‹¤íŒ¨)'));
	    }
	  }

	  // ì´ˆê¸° ë¡œë“œ: ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ë‚´ë ¤ì¤€ uid ê¸°ì¤€ìœ¼ë¡œ ì²« ë ˆë²¨ë§Œ ê·¸ë¦¼
	  (async function init(){
	    const rootUid = /*[[${uid}]]*/ null;  // ëª¨ë¸ì— ìˆëŠ” ìª½ ì‚¬ìš©
	    if (!rootUid) return;

	    const tree = document.getElementById('tree');
	    tree.textContent = ''; // ì´ˆê¸°í™”

	    // ë£¨íŠ¸ ìì²´ë¥¼ í•­ëª©ì²˜ëŸ¼ ë§Œë“  ë’¤, í•˜ìœ„ ëª©ë¡ì„ ì±„ìš°ëŠ” ë°©ì‹
	    const rootLi = makeItem({ uid: rootUid, name: 'ë£¨íŠ¸' });
	    tree.appendChild(rootLi);

	    try {
	      const res = await fetch(API(rootUid), { cache: 'no-store' });
	      if (!res.ok) throw new Error('dir list fetch failed');
	      const data = await res.json();
	      const children = parseChildren(data);

	      // ë£¨íŠ¸ í•˜ìœ„ ê·¸ë¦¬ê¸°
	      renderChildrenUnder(rootLi, children);
	    } catch (e) {
	      console.error(e);
	      renderChildrenUnder(rootLi, []);
	      rootLi.querySelector(':scope > ul > li')?.replaceChildren(document.createTextNode('(ë¡œë“œ ì‹¤íŒ¨)'));
	    }
	  })();
	  </script>
	</div>

</body>
</html>