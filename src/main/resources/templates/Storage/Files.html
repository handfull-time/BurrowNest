<div xmlns:th="http://www.thymeleaf.org" th:fragment="files"
     class="p-2 text-sm bg-white text-black select-none h-full w-full overflow-hidden">
<div class="w-full h-screen flex flex-col">
  <!-- 보기 전환 버튼 -->
  <div class="flex justify-end p-2 gap-2 border-b border-gray-300">
    <button class="px-3 py-1 border rounded hover:bg-gray-100" id="detailViewBtn">상세보기</button>
    <button class="px-3 py-1 border rounded hover:bg-gray-100" id="iconViewBtn">큰 아이콘 보기</button>
  </div>

  <!-- 파일/폴더 목록 -->
  <div class="flex-1 overflow-auto p-4">
    <div class="grid grid-cols-10 gap-4" id="fileGrid">
      <!-- 항목이 여기에 렌더링됨 -->
    </div>
  </div>
</div>

<!-- 아이콘 보기용 템플릿 -->
<template id="fileItemIconTemplate">
  <div class="file-item flex flex-col items-center p-2 border border-gray-200 rounded hover:bg-blue-50 cursor-pointer">
    <div class="thumb w-16 h-16 bg-gray-100 rounded overflow-hidden">
      <img class="thumb-img w-full h-full object-cover hidden" loading="lazy" />
      <i class="icon fa-solid fa-file text-gray-400 text-xl flex items-center justify-center h-full"></i>
    </div>
    <div class="file-name text-sm text-center mt-2 truncate w-20"></div>
  </div>
</template>

<!-- 상세 보기용 템플릿 (table row) -->
<template id="fileItemDetailTemplate">
  <tr class="file-item hover:bg-blue-50 cursor-pointer">
    <td class="w-8 text-center">
      <i class="icon fa-solid fa-file text-gray-400"></i>
    </td>
    <td class="file-name text-left"></td>
    <td class="file-size text-right text-sm text-gray-500 pr-4"></td>
  </tr>
</template>

<script th:inline="javascript">

let currentView = 'icon'; // 'icon' or 'detail'

document.getElementById('detailViewBtn').addEventListener('click', () => {
  currentView = 'detail';
  renderFileList(lastFetchedList);
});

document.getElementById('iconViewBtn').addEventListener('click', () => {
  currentView = 'icon';
  renderFileList(lastFetchedList);
});


	
	let selectedItems = new Set();
	
	// 파일 리스트 가져오기
	async function loadFileList(uid) {
		
		console.info('loadFileList', uid );
		
		const url = /*[[@{/Dir/Files.json}]]*/ null;
		
		const params = new URLSearchParams({
			uid: uid || ''
		});
		
		const fileListUrl = url + '?' + params.toString();
		
		try {
			const res = await fetch(fileListUrl);
			const list = await res.json(); 
			console.info( list );
			
			renderFileList(list);
		} catch (err) {
			console.error("파일 목록 불러오기 실패:", err);
		}
	}

	const THUMBNAIL_URL = /*[[@{/Files/Thumbnail}]]*/ '/Files/Thumbnail';
	let lastFetchedList = [];

	document.getElementById('detailViewBtn').addEventListener('click', () => {
	  currentView = 'detail';
	  renderFileList(lastFetchedList);
	});

	document.getElementById('iconViewBtn').addEventListener('click', () => {
	  currentView = 'icon';
	  renderFileList(lastFetchedList);
	});

	function renderFileList(list) {
	  lastFetchedList = list;
	  const fileGrid = document.getElementById('fileGrid');
	  fileGrid.innerHTML = '';

	  if (currentView === 'icon') {
	    fileGrid.className = 'grid grid-cols-10 gap-4';
	  } else {
	    fileGrid.className = '';
	    const table = document.createElement('table');
	    table.className = 'table-auto w-full text-sm';
	    const tbody = document.createElement('tbody');
	    fileGrid.appendChild(table);
	    table.appendChild(tbody);
	  }

	  for (const item of list) {
	    if (currentView === 'icon') {
	      const template = document.getElementById('fileItemIconTemplate');
	      const clone = template.content.cloneNode(true);
	      const root = clone.querySelector('.file-item');
	      const img = clone.querySelector('.thumb-img');
	      const icon = clone.querySelector('.icon');
	      const nameDiv = clone.querySelector('.file-name');

	      root.dataset.uid = item.uid;
	      nameDiv.textContent = item.name;

	      if (item.isFile && item.fileType === 'Image') {
	        img.src = `${THUMBNAIL_URL}/${encodeURIComponent(item.uid)}`;
	        img.classList.remove('hidden');
	        icon.remove();
	      } else {
	        icon.className = `icon fa-solid ${item.isFile ? 'fa-file' : 'fa-folder'} text-gray-400 text-xl`;
	      }

	      fileGrid.appendChild(clone);
	    } else {
	      const template = document.getElementById('fileItemDetailTemplate');
	      const clone = template.content.cloneNode(true);
	      const row = clone.querySelector('.file-item');
	      const icon = clone.querySelector('.icon');
	      const nameTd = clone.querySelector('.file-name');
	      const sizeTd = clone.querySelector('.file-size');

	      row.dataset.uid = item.uid;
	      nameTd.textContent = item.name;
	      sizeTd.textContent = item.isFile ? formatFileSize(item.fileLength) : '';

	      icon.className = `icon fa-solid ${item.isFile ? 'fa-file' : 'fa-folder'} text-gray-400`;

	      fileGrid.querySelector('tbody').appendChild(clone);
	    }
	  }
	}


	  // Ctrl + 클릭 선택
	  document.getElementById('fileGrid').addEventListener('click', (e) => {
	    const item = e.target.closest('.file-item');
	    if (!item) return;

	    const uid = item.dataset.uid;

	    if (e.ctrlKey) {
	      if (selectedItems.has(uid)) {
	        selectedItems.delete(uid);
	        item.classList.remove('bg-blue-200');
	      } else {
	        selectedItems.add(uid);
	        item.classList.add('bg-blue-200');
	      }
	    } else {
	      document.querySelectorAll('.file-item').forEach(el => el.classList.remove('bg-blue-200'));
	      selectedItems.clear();
	      selectedItems.add(uid);
	      item.classList.add('bg-blue-200');
	    }
	  });
	  
	  
	  function formatFileSize(bytes) {
		  if (bytes < 1024) return bytes + ' B';
		  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
		  if (bytes < 1024 * 1024 * 1024) return (bytes / 1024 / 1024).toFixed(1) + ' MB';
		  return (bytes / 1024 / 1024 / 1024).toFixed(1) + ' GB';
		}


</script>

<!-- <script src="https://kit.fontawesome.com/a2e0b2d4f1.js" crossorigin="anonymous"></script> -->


</div>
