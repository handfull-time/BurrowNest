<div xmlns:th="http://www.thymeleaf.org" th:fragment="files"
     class="p-2 text-sm bg-white text-black select-none h-full w-full overflow-hidden">
<div class="w-full h-screen flex flex-col">
  <!-- Î≥¥Í∏∞ Ï†ÑÌôò Î≤ÑÌäº -->
  <div class="flex justify-end p-2 gap-2 border-b border-gray-300">
    <button class="px-3 py-1 border rounded hover:bg-gray-100" id="detailViewBtn">ÏÉÅÏÑ∏Î≥¥Í∏∞</button>
    <button class="px-3 py-1 border rounded hover:bg-gray-100" id="iconViewBtn">ÌÅ∞ ÏïÑÏù¥ÏΩò Î≥¥Í∏∞</button>
  </div>

  <!-- ÌååÏùº/Ìè¥Îçî Î™©Î°ù -->
  <div class="flex-1 overflow-auto p-4">
    <div class="grid grid-cols-10 gap-4" id="fileGrid">
      <!-- Ìï≠Î™©Ïù¥ Ïó¨Í∏∞Ïóê Î†åÎçîÎßÅÎê® -->
    </div>
  </div>
</div>

<!-- ÏïÑÏù¥ÏΩò Î≥¥Í∏∞Ïö© ÌÖúÌîåÎ¶ø -->
<template id="fileItemIconTemplate">
  <div class="file-item flex flex-col items-center p-2 border border-gray-200 rounded hover:bg-blue-50 cursor-pointer">
    <div class="thumb w-16 h-16 bg-gray-100 rounded overflow-hidden">
      <img class="thumb-img w-full h-full object-cover hidden" loading="lazy" />
      <i class="icon fa-solid fa-file text-gray-400 text-xl flex items-center justify-center h-full"></i>
    </div>
    <div class="file-name text-sm text-center mt-2 truncate w-20"></div>
  </div>
</template>

<!-- ÏÉÅÏÑ∏ Î≥¥Í∏∞Ïö© ÌÖúÌîåÎ¶ø (table row) -->
<template id="fileItemDetailTemplate">
  <tr class="file-item">
    <td class="border p-2 text-center"><i class="icon fa-solid"></i></td>
    <td class="border p-2 text-left file-name"></td>
    <td class="border p-2 text-center file-date"></td>
    <td class="border p-2 text-center file-type"></td>
    <td class="border p-2 text-right file-size"></td>
  </tr>
</template>

<!-- ÏÉÅÏÑ∏ Î≥¥Í∏∞Ïö© ÌÖúÌîåÎ¶ø (table row) -->
<template id="fileItemDetailTableTemplate">
	<table class="table-auto w-full border-collapse border border-gray-200 text-sm">
        <thead>
            <tr class="bg-gray-100">
                <th class="border p-2 text-center"></th>
                <th class="border p-2 text-center">Ïù¥Î¶Ñ</th>
                <th class="border p-2 text-center">ÏàòÏ†ïÎÇ†Ïßú</th>
                <th class="border p-2 text-center">Ïú†Ìòï</th>
                <th class="border p-2 text-center">ÌÅ¨Í∏∞</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</template>

<script th:inline="javascript">

	let currentView = 'icon'; // 'icon' or 'detail'
	
	document.getElementById('detailViewBtn').addEventListener('click', () => {
	  currentView = 'detail';
	  renderFileList(lastFetchedList);
	});
	
	document.getElementById('iconViewBtn').addEventListener('click', () => {
	  currentView = 'icon';
	  renderFileList(lastFetchedList);
	});


	
	//let selectedItems = new Set();
	
	// ÌååÏùº Î¶¨Ïä§Ìä∏ Í∞ÄÏ†∏Ïò§Í∏∞
	async function loadFileList(uid) {
		
		console.info('loadFileList', uid );
		
		const url = /*[[@{/Dir/Files.json}]]*/ null;
		
		const params = new URLSearchParams({
			uid: uid || ''
		});
		
		const fileListUrl = url + '?' + params.toString();
		
		try {
			const res = await fetch(fileListUrl);
			const list = await res.json(); 
			console.info( list );
			
			renderFileList(list);
		} catch (err) {
			console.error("ÌååÏùº Î™©Î°ù Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®:", err);
		}
	}

	const THUMBNAIL_URL = /*[[@{/Files/Thumbnail}]]*/ '/Files/Thumbnail';
	let lastFetchedList = [];

	document.getElementById('detailViewBtn').addEventListener('click', () => {
	  currentView = 'detail';
	  renderFileList(lastFetchedList);
	});

	document.getElementById('iconViewBtn').addEventListener('click', () => {
	  currentView = 'icon';
	  renderFileList(lastFetchedList);
	});

	
	function renderFileList2(list) {
		lastFetchedList = list;
		const fileGrid = document.getElementById('fileGrid');
		fileGrid.innerHTML = '';
		
		if (currentView === 'icon') {
			fileGrid.className = 'grid grid-cols-10 gap-4';
			
			for (const item of list) {
			    const template = document.getElementById('fileItemIconTemplate');
			    const clone = template.content.cloneNode(true);
			    const root = clone.querySelector('.file-item');
			    const img = clone.querySelector('.thumb-img');
			    const icon = clone.querySelector('.icon');
			    const nameDiv = clone.querySelector('.file-name');
			
			    root.dataset.uid = item.uid;
			    nameDiv.textContent = item.name;
			
			    if (item.file && item.fileType === 'Image') {
			        img.src = `${THUMBNAIL_URL}/${encodeURIComponent(item.uid)}`;
			        img.loading = 'lazy';
			        img.classList.remove('hidden');
			        icon.remove();
				} else {
			        icon.textContent = item.isFile ? 'üìÑ' : 'üìÅ';
			        icon.className = 'icon text-4xl flex items-center justify-center h-16';
				}
			
			    fileGrid.appendChild(clone);
			}
		} else {
			
			fileGrid.className = '';

		    const tableTemplate = document.getElementById('fileItemDetailTableTemplate');
		    const tableClone = tableTemplate.content.cloneNode(true);
		    const table = tableClone.querySelector('table');
		    const tbody = table.querySelector('tbody');
		    fileGrid.appendChild(table);
		    
		  	for (const item of list) {
		  		const template = document.getElementById('fileItemDetailTemplate');
		        const clone = template.content.cloneNode(true);
		        const row = clone.querySelector('.file-item');
		        const icon = clone.querySelector('.icon');
		        const nameTd = clone.querySelector('.file-name');
		        const dateTd = clone.querySelector('.file-date');
		        const typeTd = clone.querySelector('.file-type');
		        const sizeTd = clone.querySelector('.file-size');

		        row.dataset.uid = item.uid;
		        nameTd.textContent = item.name;
		        dateTd.textContent = 'ÏãúÍ∞ÑÏûëÏóÖÌïòÏûê'; //item.lastModified ?? ''; // ÌïÑÏöîÌïú Í≤ΩÏö∞ ÎÇ†Ïßú Ìè¨Îß∑ÌåÖ Ï∂îÍ∞Ä
		        typeTd.textContent = item.isFile ? item.extension ?? '' : 'Ìè¥Îçî';
		        sizeTd.textContent = item.isFile ? formatFileSize(item.fileLength) : '';
			
		        if (item.file && item.fileType === 'Image') {
		            img.src = `${THUMBNAIL_URL}/${encodeURIComponent(item.uid)}`;
		            img.loading = 'lazy';
		            img.classList.remove('hidden');
		            icon.remove();
			    } else {
				    icon.textContent = item.isFile ? 'üìÑ' : 'üìÅ';
			        icon.className = 'icon';
			    }
			
			    tbody.appendChild(clone);
			}
		}
	}
	
	function renderFileList(list) {
		lastFetchedList = list;
		const fileGrid = document.getElementById('fileGrid');
		fileGrid.innerHTML = '';
		
		let lastSelectedIndex = null;
		const selectedUids = new Set();
		
		function clearSelection() {
		  selectedUids.clear();
		  fileGrid.querySelectorAll('.file-item').forEach(el => el.classList.remove('bg-blue-100'));
		}
		
		function toggleSelection(uid, element) {
			if (selectedUids.has(uid)) {
			  selectedUids.delete(uid);
			  element.classList.remove('bg-blue-100');
			} else {
			  selectedUids.add(uid);
			  element.classList.add('bg-blue-100');
			}
		}

		function selectRange(start, end) {
			clearSelection();
			const items = Array.from(fileGrid.querySelectorAll('.file-item'));
			const [from, to] = [start, end].sort((a, b) => a - b);
			for (let i = from; i <= to; i++) {
				const el = items[i];
				const uid = el.dataset.uid;
				selectedUids.add(uid);
				el.classList.add('bg-blue-100');
			}
		}

		const isIconView = currentView === 'icon';
		fileGrid.className = isIconView ? 'grid grid-cols-10 gap-4' : '';
		
		let table;
		if (!isIconView) {
			const tableTemplate = document.getElementById('fileItemDetailTableTemplate');
			const tableClone = tableTemplate.content.cloneNode(true);
			table = tableClone.querySelector('table');
			fileGrid.appendChild(table);
		}
	
		list.forEach((item, index) => {
			const template = document.getElementById(isIconView ? 'fileItemIconTemplate' : 'fileItemDetailTemplate');
			const clone = template.content.cloneNode(true);
			const element = clone.querySelector('.file-item');
			const icon = clone.querySelector('.icon');
			const img = clone.querySelector('.thumb-img');
			
			element.dataset.uid = item.uid;
			element.dataset.index = index;
			
			if (isIconView) {
				const nameDiv = clone.querySelector('.file-name');
				nameDiv.textContent = item.name;
			} else {
				const nameTd = clone.querySelector('.file-name');
				const dateTd = clone.querySelector('.file-date');
				const typeTd = clone.querySelector('.file-type');
				const sizeTd = clone.querySelector('.file-size');
				
				nameTd.textContent = item.name;
				dateTd.textContent = item.lastModified ?? '';
				typeTd.textContent = item.isFile ? item.extension ?? '' : 'Ìè¥Îçî';
				sizeTd.textContent = item.isFile ? formatFileSize(item.fileLength) : '';
			}
			
			if (item.isFile && item.fileType === 'Image') {
				img.src = `${THUMBNAIL_URL}/${encodeURIComponent(item.uid)}`;
				img.loading = 'lazy';
				img.classList.remove('hidden');
				icon.remove();
			} else {
				icon.textContent = item.isFile ? 'üìÑ' : 'üìÅ';
				icon.className = isIconView ? 'icon text-4xl flex items-center justify-center h-16' : 'icon';
			}
			
			(table?.querySelector('tbody') ?? fileGrid).appendChild(clone);
		});
		
		fileGrid.addEventListener('click', (e) => {
			const itemEl = e.target.closest('.file-item');
			if (!itemEl) return;
			
			const uid = itemEl.dataset.uid;
			const index = parseInt(itemEl.dataset.index);
			
			if (e.shiftKey && lastSelectedIndex != null) {
			  selectRange(lastSelectedIndex, index);
			} else if (e.ctrlKey || e.metaKey) {
			  toggleSelection(uid, itemEl);
			} else {
			  clearSelection();
			  selectedUids.add(uid);
			  itemEl.classList.add('bg-blue-100');
			}
			
			lastSelectedIndex = index;
		});
	}

	function clearSelected(rootNode) {
		if (!rootNode) return;
		rootNode.selected = false;
		
		if (rootNode.child) {
			rootNode.child.forEach(clearSelected);
		}
	}

	function clearSelectedExcept(uid) {
		const root = document.getElementById("tree");
		if (!root) return;
		
		function traverse(node) {
			if (!node._nodeData) return;
			if (node._nodeData.owner.uid !== uid) {
				node._nodeData.selected = false;
			}
			const children = node.querySelectorAll(':scope > ul > li > div');
			children.forEach(child => traverse(child));
		}
		
		root.querySelectorAll('[data-node="true"]').forEach(el => {
			if (el._nodeData?.owner.uid !== uid) {
				el._nodeData.selected = false;
			}
		});
	}


	// Ctrl + ÌÅ¥Î¶≠ ÏÑ†ÌÉù
	/*
	document.getElementById('fileGrid').addEventListener('click', (e) => {
	    const item = e.target.closest('.file-item');
	    if (!item) return;

	    const uid = item.dataset.uid;

	    if (e.ctrlKey) {
	      if (selectedItems.has(uid)) {
	        selectedItems.delete(uid);
	        item.classList.remove('bg-blue-200');
	      } else {
	        selectedItems.add(uid);
	        item.classList.add('bg-blue-200');
	      }
	    } else {
	      document.querySelectorAll('.file-item').forEach(el => el.classList.remove('bg-blue-200'));
	      selectedItems.clear();
	      selectedItems.add(uid);
	      item.classList.add('bg-blue-200');
	    }
	}); */
	  
	  
	function formatFileSize(bytes) {
		if (bytes < 1024) return bytes + ' B';
		if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
		if (bytes < 1024 * 1024 * 1024) return (bytes / 1024 / 1024).toFixed(1) + ' MB';
		return (bytes / 1024 / 1024 / 1024).toFixed(1) + ' GB';
	}


</script>

<!-- <script src="https://kit.fontawesome.com/a2e0b2d4f1.js" crossorigin="anonymous"></script> -->


</div>
