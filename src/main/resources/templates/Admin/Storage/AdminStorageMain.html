<div xmlns:th="http://www.thymeleaf.org"
     xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
     layout:decorate="~{Admin/Common/AdminLayout}">

    <th:block layout:fragment="title">그룹 저장소 관리</th:block>

    <th:block layout:fragment="css"></th:block>

    <div layout:fragment="content">
    	<div class="bg-white grid grid-cols-5 gap-4">
    		<!-- 그룹 목록 -->
    		<div class="col-span-1 border rounded shadow">
    			<div class="bg-gray-100 font-bold text-center py-2 border-b">그룹명</div>
    			<div class="overflow-y-auto">
	                <ul id="groupList" class="divide-y">
	                    <li th:each="group : ${groupList}" th:data-no="${group.groupNo}"
	                        class="p-2 cursor-pointer hover:bg-blue-100" 
	                        th:text="${group.name}"></li>
	                </ul>
	            </div>
		  	</div>
    	
    		<!-- 접근 디렉토리 목록 -->
		  	<div class="col-span-4 border rounded shadow">
			    <div class="bg-gray-100 font-bold text-center py-2 border-b">접근 Directory</div>
                <ul id="directoryList" class="space-y-1"></ul>
                <div class="flex mt-2">
                    <input id="newDirInput" type="text" placeholder="추가할 디렉터리 경로" 
                           class="border rounded w-full px-2 py-1 mr-2">
                    <button id="addDirBtn" class="bg-blue-500 text-white px-3 py-1 rounded">+</button>
                </div>
			</div>
    	</div>
         
		<template id="directoryItemTemplate">
		  <li class="flex items-center justify-between px-4 py-2">
		    <span class="dir-path flex-1 truncate"></span>
		    <button class="remove-dir ml-2 bg-red-500 hover:bg-red-600 text-white text-sm px-2 py-1 rounded">-</button>
		  </li>
		</template>
		
		<template id="directoryAddTemplate">
		  <li class="flex items-center justify-between px-4 py-2">
		    <input type="text" class="dir-input border px-2 py-1 flex-1 text-sm" placeholder="경로 입력..." />
		    <button id="GroupDirAdd" class="add-dir ml-2 bg-blue-500 hover:bg-blue-600 text-white text-sm px-2 py-1 rounded">+</button>
		  </li>
		</template>
        
    </div>

    <th:block layout:fragment="script">
    <script th:inline="javascript">
    const groupListEl = document.getElementById("groupList");
    const directoryListEl = document.getElementById("directoryList");
    const newDirInput = document.getElementById("newDirInput");
    const addDirBtn = document.getElementById("addDirBtn");

    let currentGroupNo = null;

    groupListEl.addEventListener("click", async (e) => {
        const li = e.target.closest("li");
        if (!li) return;

        groupListEl.querySelectorAll("li").forEach(el => el.classList.remove("bg-blue-500", "text-white"));
        li.classList.add("bg-blue-500", "text-gray");

        const options = {
    			method: 'GET',
    			headers: {
    				'Content-Type': 'application/x-www-form-urlencoded',
    			},
    	    };
        
        currentGroupNo = li.dataset.no;
        const address = /*[[@{/Admin/Storage/GroupStorageList.json}]]*/null;
        const url = `${address}?GroupNo=${currentGroupNo}`;
        const response = await apiRequest(url, options);
        if (!response.ok) {
            throw new Error(`HTTP 오류 발생: ${response.status} ${response.statusText}`);
        }
        
        const list = await response.json();

        renderDirectoryList(list);
    });

    addDirBtn.addEventListener("click", () => {
        const name = newDirInput.value.trim();
        if (!name || !currentGroupNo) return;

        const li = document.createElement("li");
        li.className = "flex justify-between items-center bg-white border p-2 rounded";
        li.innerHTML = `<span>${name}</span><button class='text-red-500 hover:text-red-700'>-</button>`;
        directoryListEl.appendChild(li);

        newDirInput.value = "";

        // TODO: API 저장 연동 필요
    });

    function renderDirectoryList2(list) {
        directoryListEl.innerHTML = '';
        list.forEach(dir => {
            const li = document.createElement("li");
            li.className = "flex justify-between items-center bg-white border p-2 rounded";
            li.innerHTML = `<span>${dir.name}</span><button class='text-red-500 hover:text-red-700'>-</button>`;
            directoryListEl.appendChild(li);

            li.querySelector("button").addEventListener("click", () => {
                li.remove();
                // TODO: API 삭제 연동 필요
            });
        });
    }
    
    async function removeDir(){
    	
    }
    
    function renderDirectoryList(dirs) {
    	const dirTemplate = document.getElementById("directoryItemTemplate");
    	const addTemplate = document.getElementById("directoryAddTemplate");
	  
	    directoryListEl.innerHTML = "";
	    dirs.forEach((dir, idx) => {
	      const li = dirTemplate.content.cloneNode(true);
	      const dirPath = li.querySelector(".dir-path");
	      dirPath.textContent = dir.absolutePath;
	      dirPath.dataset.no = dir.no;
	      li.querySelector(".remove-dir").addEventListener("click", () => {
	    	  const message = `[ ${dir.absolutePath} ] 삭제하시겠습니까?`;
	    	  showCustomConfirm( message, () => handleRemoveDirectory(dir));
	      });
	      directoryListEl.appendChild(li);
	    });

	    const addLi = addTemplate.content.cloneNode(true);
	    addLi.querySelector(".add-dir").addEventListener("click", () => {
	    	alert('추가');
	    });
	    directoryListEl.appendChild(addLi);
	  }
    
    async function handleRemoveDirectory(dir) {
    	  try {
    	    const address = /*[[@{/Admin/Storage/RemoveDir.json}]]*/ null;
    	    const url = `${address}?GroupNo=${currentGroupNo}&DirNo=${dir.no}`;

    	    const options = { method: "POST" }; // 필요 시 옵션 구성
    	    const response = await apiRequest(url, options);

    	    if (!response.ok) {
    	      throw new Error(`HTTP 오류 발생: ${response.status} ${response.statusText}`);
    	    }

    	    const result = await response.json();

    	    // 성공 처리 후 UI 갱신
    	    alert(`${dir.absolutePath} 제거됨`);
    	    loadDirectoryList(currentGroupNo); // 필요 시 목록 재로딩 함수 호출

    	  } catch (error) {
    	    alert(`삭제 실패: ${error.message}`);
    	  }
    }
    </script>
    </th:block>

</div>
