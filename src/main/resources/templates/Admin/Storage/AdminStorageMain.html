<div xmlns:th="http://www.thymeleaf.org"
     xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
     layout:decorate="~{Admin/Common/AdminLayout}">

    <th:block layout:fragment="title">관리자 저장소</th:block>

    <th:block layout:fragment="css"></th:block>

    <div layout:fragment="content">
    	<div class="col-span-4 border rounded shadow">
    		<h2 class="text-2xl font-semibold text-center text-gray-800">저장소 지정</h2>
        	<ul id="storageList" class="space-y-2 h-58">
        	</ul>
    	</div>
    	
    	<div class="bg-gray-50 p-6 font-sans hidden" id="progressContainer">
        	<div class="max-w-xl mx-auto bg-white shadow-lg rounded-xl p-6 space-y-4">
			    <div id="progressView">
				    <div id="message" class="text-gray-700 text-center text-base font-medium">메시지</div>
				
				    <div class="relative w-full h-6 bg-gray-200 rounded-full overflow-hidden">
				    	<div id="progressBar" class="absolute top-0 left-0 h-full bg-blue-500 transition-all duration-300 ease-in-out" style="width: 0%;"></div>
				    </div>
				
				    <div class="flex justify-between text-sm text-gray-600">
				      	<span id="progressText">0 / 0</span>
				      	<span id="progressPercent">0%</span>
				    </div>
			    </div>
		  	</div>
		</div>
		
		<template id="directoryItemTemplate">
			<li class="flex items-center justify-between px-4 py-2 bg-gray-100 rounded">
				<span class="dir-name-path flex-1 truncate text-gray-800"></span>
				<button class="remove-dir ml-2 bg-red-500 hover:bg-red-600 text-white text-sm px-2 py-1 rounded">-</button>
			</li>
		</template>
		
		<template id="directoryAddTemplate">
			<li class="flex items-center justify-between px-4 py-2">
				<span class=""></span>
				<button id="GroupDirAdd" class="add-dir ml-2 bg-blue-500 hover:bg-blue-600 text-white text-sm px-2 py-1 rounded">+</button>
			</li>
		</template>
    </div>

    <th:block layout:fragment="script">
    <script type="text/javascript" th:src="@{/js/websocket/sockjs.min.js}"></script>
    <script type="text/javascript" th:src="@{/js/websocket/stomp.min.js}"></script>
    <script type="text/javascript" th:src="@{/js/websocket/BurrowSocket.js}"></script>
    
    <script th:inline="javascript">
    
    document.addEventListener('DOMContentLoaded', () => {

        const storageList = document.getElementById('storageList');
        // 기존 목록을 비웁니다 (다시 로드할 경우를 대비).
        storageList.innerHTML = ''; 

        const storageDataList = /*[[${directories}]]*/ null;
    	
        populateStorageList( storageList, storageDataList);
    });
    
    /**
     * storageDataList의 데이터를 기반으로 storageList UL을 채웁니다.
     */
    function populateStorageList(ele, list) {
        
    	const template = document.getElementById('directoryItemTemplate');
    	
        list.forEach(item => {
        	// 템플릿 내용(content)을 복제하여 새로운 li 요소를 만듭니다.
            const listItem = template.content.cloneNode(true);
            
            // 복제된 li 내에서 클래스명으로 요소를 찾아서 내용을 채웁니다.
            const namePathSpan = listItem.querySelector('.dir-name-path');
            if (namePathSpan) {
                namePathSpan.textContent = `${item.name} (${item.absolutePath})`;
                // data-no 속성을 li 자체에 추가하여 항목의 고유 ID를 저장합니다.
                listItem.querySelector('li').setAttribute('data-no', item.no);
            }

            const deleteButton = listItem.querySelector('.remove-dir');
            if (deleteButton) {
                deleteButton.onclick = function() {
                    // 버튼의 부모 li 요소를 찾아 삭제합니다.
                    // closest('li')를 사용하여 확실하게 li 요소를 찾습니다.
                    const liToRemove = this.closest('li');
                    if (liToRemove) {
                        liToRemove.remove();
                        // 필요하다면 여기서 서버에도 삭제 요청을 보낼 수 있습니다.
                        console.log(`Item with no: ${item.no} deleted from UI.`);
                        // 실제 서버 삭제 로직 (예: fetch('/api/deleteStorage', { method: 'POST', body: JSON.stringify({ no: item.no }) }))
                    }
                };
            }
            ele.appendChild(listItem);
        });
        
        const addLi = document.getElementById('directoryAddTemplate').content.cloneNode(true);
		addLi.querySelector(".add-dir").addEventListener("click", openSelectDir);
		ele.appendChild(addLi);
    }
    
    /**
     * 폴더 목록 전달
     */
	function getStorageListValues() {
	  const spans = document.querySelectorAll('#storageList li span');
	  return Array.from(spans).map(span => span.textContent.trim());
	}
	
	function openSelectDir(){
		console.log("openSelectDir click");

        const sendValue = {
		        url: /*[[@{/Intro/Dir.layer}]]*/ null,
				method: MethodType.Get, 
				NotCheck:true,
				popupId:'SelectDir',
		        width: '600px'
		    };
		
		openPopup(sendValue);
	}
	
	/**
	 * 팝업창에서 선택한 목록들 화면 처리.
	 */
	function procNames(names){
		
		for (let name of names) {
		    const list = document.getElementById('storageList');
		    const li = document.createElement('li');
		    li.className = 'flex justify-between items-center bg-gray-100 p-2 rounded';
		    li.innerHTML = `<span>${name}</span><button class="text-red-500 hover:text-red-700" onclick="this.closest('li').remove()">삭제</button>`;
		    list.appendChild(li);
		}
		  
		const selectList = getStorageListValues();
		buttonStatus( "selectNextBtn", selectList.length > 0);
	}
	
	const eleMessage = document.getElementById("message");
    const eleProgressText = document.getElementById("progressText");
    const eleProgressBar = document.getElementById("progressBar");
    const eleProgressPercent = document.getElementById("progressPercent");

    // 4. 저장 상태가 전달됨.
    function updateProgress(receiveData) {
    	
    	console.log("User 소켓 데이터 수신 " + receiveData.body);
    	const json = JSON.parse(receiveData.body);
    	
    	if( Boolean(json.done) ){
    		// 작업 완료.
    		eleMessage.textContent = "✅ 완료";
    		
    		socketScript.disconnect();
    		
    		showCustomAlert( "정보 읽기 완료.", () => {
    			location.reload();
    		});
    		return;
    	}

    	const total = Number(json.total);
    	const progress = Number(json.progress);
    	const message  = json.message;
    	
    	const percent = total > 0 ? Math.floor((progress / total) * 100) : 0;
    	
    	eleMessage.textContent = message || "";
    	eleProgressText.textContent = `${progress} / ${total}`;
    	eleProgressBar.style.width = `${percent}%`;
    	eleProgressPercent.textContent = `${percent}%`;
    }
    
    let socketScript = null;
    
    function apply(){
    	
    	buttonStatus( "applyBtn", false);
    	
    	// 1. 웹 소켓 접속.
    	const wsUrl = /*[[@{/BackEvent}]]*/ null;
    	const connectionInfo = new ConnectionInfo(wsUrl, { service: 'Burrow' });
    	
    	connectionInfo.setOpenHandler((frame) => {
    		
    		// 2. 접속 성공 하면 user-name 획득
    		const currentUserKey = frame.headers['user-name'];
    		console.log("연결됨", currentUserKey );
    		
    		saveRootStoreage( currentUserKey );
    	});
    	
    	connectionInfo.setCloseHandler(() => {
    		console.log("연결 해제");
    	});

    	socketScript = new SocketScript(connectionInfo);
    	
    	socketScript.addReceiveInfo(new ReceiveInfo('/user/toFront/RecieveStatus', updateProgress));
    	
    	socketScript.connect();
    }
    
    
    // 3. saveInit 호출
	async function saveRootStoreage(wsUser){
		
    	const progressContainer = document.getElementById('progressContainer');
    	progressContainer.classList.remove('hidden');
    	
        const storageList = getStorageListValues();
        
        
        const formData = new FormData();
        formData.append("roots", storageList);
        formData.append("wsUserName", wsUser);
        
		try {
	        const res = await fetch(/*[[@{/Admin/SaveStorage.json}]]*/ null, {
                method: "POST",
                body: formData,
                credentials: "include"
            });
	        
	        console.info('✅ response', res);

	        if (res.ok) {
	        	console.info('작업 진행 중');
	        }
	        return true;
	    } catch (err) {
	        console.error("refreshToken 실패:", err);
	        progressContainer.classList.add('hidden');
	        return false;
	    }
	}
    </script>
    </th:block>

</div>
