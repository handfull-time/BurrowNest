<div xmlns:th="http://www.thymeleaf.org"
     xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
     layout:decorate="~{Admin/Common/AdminLayout}">

    <th:block layout:fragment="title">그룹 회원 관리</th:block>

    <th:block layout:fragment="css"></th:block>

    <div layout:fragment="content">
        <!-- 회원 검색 -->
        <div class="bg-white shadow p-6 rounded-md mb-6">
            <h2 class="text-xl font-bold text-gray-700 mb-4">그룹 검색</h2>
            <div class="flex space-x-4">
                <input type="text" id="searchName" placeholder="그룹 이름 입력"
                       class="border p-2 rounded w-1/3 focus:outline-none focus:ring-2 focus:ring-blue-600">
                <button type="button" class="bg-blue-600 text-white p-2 rounded hover:bg-blue-700" onclick="search()">검색</button>
                <button type="button" class="bg-green-600 text-white p-2 rounded hover:bg-green-700" onclick="onGroupDetail(0)">추가</button>
            </div>
        </div>

        <!-- 그룹 목록 -->
        <div id="ResultList"></div>
        <div id="PathList"></div>
    </div>

    <th:block layout:fragment="script">
    <script th:inline="javascript">
		// 첫 로딩시 검색    
        document.addEventListener('DOMContentLoaded', () => {
            search();
        });
        
		// 검색
        async function search(){
        	
        	const pathList = document.getElementById('PathList');

            if (!pathList) {
            	pathList.innerHTML = '';
            }
        	
        	const searchName = document.getElementById('searchName').value;
        	
        	const params = new URLSearchParams({
        		grName: searchName || ''
        	});

        	const options = {
        			method: 'GET',
        			headers: {
        				'Content-Type': 'application/x-www-form-urlencoded',
        			},
        	    };
        	
        	const url = /*[[@{/Admin/Group/GroupUserList.layer}]]*/ null;
        	const urlAddress = url + '?' + params.toString();
        	
        	doSearchList(urlAddress, options, 'ResultList');
        };
        
        
        // 그룹 상세 창
        function onGroupDetail(groupNo){
        	const url = /*[[@{/Admin/Group/GroupItem.layer}]]*/ null;
            const urlValue = url + '?groupNo=' + groupNo;
            
            const sendValue = {
			        url: urlValue,
					method: MethodType.Get,
			        contentType: ContentsType.Form, // 기본값: JSON
			        popupId:'Profile',
			        width: '800px'
			    };
            
            openPopup( sendValue );
        }
        
        // 그룹 루트 dir 보기
        async function onShowPath(groupNo){
        	const params = new URLSearchParams({
        		groupNo: groupNo || ''
        	});

        	const options = {
        			method: 'GET',
        			headers: {
        				'Content-Type': 'application/x-www-form-urlencoded',
        			},
        	    };
        	
        	const url = /*[[@{/Admin/Group/GroupUserStorageList.layer}]]*/ null;
        	const urlAddress = url + '?' + params.toString();
        	
        	doSearchList(urlAddress, options, 'PathList');
        }
        
        function getGroupInfo(){
			return getFormObject('updateGroupForm');
		}
		
		function deleteGroup(ele) {
			
			showCustomConfirm("정말로 이 그룹을 삭제하시겠습니까?", async (isConfirm) => {
            	
            	if( ! isConfirm ){
            		return;
            	}
            	
               	const url = /*[[@{/Admin/Group/DeleteGroup.json}]]*/ null;
               	
            	const options = {
            			method: 'POST',
            			headers: {
            				'Content-Type': 'application/json',
            			},
            			body: JSON.stringify( getGroupInfo() ),
            	    };
            	
            	const response = await apiRequest(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP 오류 발생: ${response.status} ${response.statusText}`);
                }
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('삭제 결과:', result);
                    if( result.code == '0' ){
                    	showCustomAlert( '삭제됐습니다.', function(){
                            location.reload(); 
                    	} );
                    }else{
                    	showCustomAlert( '삭제 실패 ' + result.code + ':' + result.message, function(){
                    		closePopup(ele);
                    	} );
                    }
                } else {
                	console.error('삭제 오류:', response.status);
                	showCustomAlert( '삭제 오류:' + response.status , function(){
                		closePopup(ele);
                	} );
                }
			});
            	
        }
		
		 // 데이터 저장
        async function saveData(ele) {
        	
        	const url = /*[[@{/Admin/Group/SaveGroup.json}]]*/ null;
        	const options = {
        			method: 'POST',
        			headers: {
        				'Content-Type': 'application/json',
        			},
        			body: JSON.stringify( getGroupInfo() ),
        	    };
        	
        	const response = await apiRequest(url, options);
            if (!response.ok) {
                throw new Error(`HTTP 오류 발생: ${response.status} ${response.statusText}`);
            }
			
            if (response.ok) {
                const result = await response.json();
                console.log('저장 결과:', result);
                if( result.code == '0' ){
                	location.reload(); 
                }else{
                	showCustomAlert( '저장 실패 ' + result.code + ':' + result.message, function(){
                		closePopup(ele);
                	} );
                }
            } else {
            	console.error('저장 오류:', response.status);
            	showCustomAlert( '저장 오류:' + response.status , function(){
            		closePopup(ele);
            	} );
            }
		 }
    </script>
    </th:block>

</div>