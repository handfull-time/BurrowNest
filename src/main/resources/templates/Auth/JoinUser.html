<div xmlns:th="http://www.thymeleaf.org"
     xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
     layout:decorate="~{Auth/UserLayout}">
     
    <th:block layout:fragment="title">가입</th:block>

	<th:block layout:fragment="css"></th:block>
    
    <div layout:fragment="content">
    	<form id="signupForm" class="w-full">
		    <table class="w-full border-collapse">
		        <tbody>
		            <!-- ID -->
		            <tr>
		                <td class="w-1/4 font-medium p-2"><label for="id">아이디</label></td>
		                <td class="w-3/4 p-2">
		                    <input type="text" id="id" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-400" minlength="4" maxlength="20" required>
		                    <p id="idCheckMessage" class="text-sm mt-1 text-red-500"></p>
		                </td>
		            </tr>
		
		            <th:block th:replace="~{Auth/AuthPassword :: AuthPassword}"></th:block>
		
		            <!-- 닉네임 및 프로필 이미지 -->
		            <tr>
		                <td class="font-medium p-2">닉네임</td>
		                <td class="p-2 flex items-center">
		                	<input type="text" id="nickname" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-400" minlength="1" maxlength="20" required>
		                	<div class="relative ml-4">
	                			<script th:replace="~{Common/ProfileImg :: JoinImageEle}"></script>
		                	</div>
		                </td>
		            </tr>
		            
		            <th:block th:replace="~{Auth/AuthHint :: AuthHint}"></th:block>
		        </tbody>
		    </table>
		    
            <div class="mt-6 transition-opacity duration-300" id="hiddenButtons">
	            <button type="submit" id="UserJoinBtn" class="w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600">가입하기</button>
	            <div class="flex justify-between mt-2 text-sm text-blue-500 cursor-pointer">
	                <a th:href="@{/Auth/FindUserPw.html}" class="hover:underline">비밀번호 찾기</a>
	                <a th:href="@{/Auth/Login.html}" class="hover:underline" >로그인</a>
	            </div>
	        </div>
		</form>
    </div>

    <th:block layout:fragment="script">
    
    <script th:inline="javascript">
		document.getElementById("id").addEventListener("blur", async function() {
		    const idInput = this.value.trim(); // 입력된 ID 값
		    const messageElement = document.getElementById("idCheckMessage");
		    
		    const idInputLen = idInput.length;
		    if( idInputLen < 1 ){
		    	messageElement.classList.add("hidden");
		    	return;
		    }
		    
		    messageElement.classList.remove("hidden");
		
		    // ID 길이 검사 (4~20자)
		    if (idInputLen < 4 || idInputLen > 20) {
		        messageElement.textContent = "아이디는 4~20자 사이로 입력해주세요.";
		        messageElement.className = "text-red-500";
		        return;
		    }
		    
		    try {
		        // API 요청 보내기
		        const checkIdUri = /*[[@{/Auth/CheckId.json}]]*/ null;
		        const response = await fetch(`${checkIdUri}?id=${encodeURIComponent(idInput)}`);
		        const data = await response.json();
		
		        if (data.code === "0") {
		            messageElement.textContent = "사용 가능한 아이디입니다.";
		            messageElement.className = "text-green-500";
		        } else if (data.code === "E") {
		            messageElement.textContent = "이미 사용 중인 아이디입니다.";
		            messageElement.className = "text-red-500";
		        } else {
		            messageElement.textContent = "서버 오류가 발생했습니다.";
		            messageElement.className = "text-red-500";
		        }
		    } catch (error) {
		        console.error("ID 체크 오류:", error);
		        messageElement.textContent = "네트워크 오류가 발생했습니다.";
		        messageElement.className = "text-red-500";
		    }
		});
		
	</script>
	
	<script th:replace="~{Common/ProfileImg :: script}"></script>
	
	<script th:replace="~{Auth/AuthPassword :: script( func = 'btnStatus' )}"></script>
	
    
    <script th:inline="javascript">
    
    document.addEventListener('DOMContentLoaded', () => {
    	buttonStatus( 'UserJoinBtn', false );
    });
    
    function btnStatus(status){
    	buttonStatus( 'UserJoinBtn', status );
    }
    
    document.getElementById("signupForm").addEventListener("submit", async function(event) {
    	event.preventDefault();
    	
    	const imageData = await getProfileImage();
    	if (!imageData) {
    		showCustomAlert("이미지 처리 오류가 발생했습니다.");
    		return;
        }
            
        const formData = new FormData();
        formData.append("token", /*[[${unique.token}]]*/ null);
        formData.append("rsaId", /*[[${unique.rsaId}]]*/ null);
        formData.append("id", document.getElementById("id").value);
        formData.append("pw", encryptPassword( document.getElementById("password").value) );
        formData.append("nickname", document.getElementById("nickname").value);
        formData.append("myRainbow", document.getElementById("myRainbow").value);
        formData.append("mySeason", document.getElementById("mySeason").value);
        formData.append("myNumber", document.getElementById("myNumber").value);
        formData.append("profileImg", imageData);

        try {
            const response = await fetch(/*[[@{/Auth/JoinUser.json}]]*/ null, {
                method: "POST",
                body: formData,
                credentials: "include"
            });

            const result = await response.json();
            if (response.ok) {
            	showCustomAlert("회원가입이 완료되었습니다.\n관리자 승인 후 사용 가능 합니다.", () => {
            		window.location.href = /*[[@{/Auth/Login.html}]]*/ null;
            	});
            } else {
            	showCustomAlert(result.message || "회원가입에 실패했습니다.");
            }
        } catch (error) {
            console.error("Error:", error);
            showCustomAlert("서버 오류가 발생했습니다.");
        }
    });
    </script>
    </th:block>
</div>