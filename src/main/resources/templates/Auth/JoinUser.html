<div xmlns:th="http://www.thymeleaf.org"
     xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
     layout:decorate="~{Auth/UserLayout}">
     
    <th:block layout:fragment="title"></th:block>

	<th:block layout:fragment="css"></th:block>
    
    <div layout:fragment="content">
    	<form id="signupForm" class="w-full">
		    <table class="w-full border-collapse">
		        <tbody>
		            <!-- ID -->
		            <tr>
		                <td class="w-1/4 font-medium p-2"><label for="id">ì•„ì´ë””</label></td>
		                <td class="w-3/4 p-2">
		                    <input type="text" id="id" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-400" minlength="4" maxlength="20" required>
		                    <p id="idCheckMessage" class="text-sm mt-1 text-red-500"></p>
		                </td>
		            </tr>
		
		            <!-- Birthday -->
		            <tr>
		                <td class="font-medium p-2">ìƒë…„ì›”ì¼</td>
		                <td class="p-2">
		                    <input type="date" id="birthday" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-400" required>
		                </td>
		            </tr>
		
		            <!-- ë¹„ë°€ë²ˆí˜¸ -->
		            <tr>
		                <td class="font-medium p-2">ë¹„ë°€ë²ˆí˜¸</td>
		                <td class="p-2">
		                    <input type="password" id="password" placeholder="ìˆ«ì, ì˜ë¬¸, íŠ¹ìˆ˜ë¬¸ì ì¤‘ 2ê°€ì§€ ì´ìƒ" 
		                    	class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-400" minlength="6" maxlength="20" required>
		                    <p id="passwordError" class="text-sm text-red-500 mt-1 hidden">ë¹„ë°€ë²ˆí˜¸ ê·œì¹™ì„ í™•ì¸í•˜ì„¸ìš”.</p>
		                </td>
		            </tr>
		
		            <!-- ë¹„ë°€ë²ˆí˜¸ í™•ì¸ -->
		            <tr>
		                <td class="font-medium p-2">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</td>
		                <td class="p-2">
		                    <input type="password" id="confirmPassword" placeholder="ìµœì†Œ 6ì, ìµœëŒ€ 20ì" 
		                    	class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-400" required>
		                    <p id="confirmPasswordError" class="text-sm text-red-500 mt-1 hidden">ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
		                </td>
		            </tr>
		
		            <!-- ë‹‰ë„¤ì„ ë° í”„ë¡œí•„ ì´ë¯¸ì§€ -->
		            <tr>
		                <td class="font-medium p-2">ë‹‰ë„¤ì„</td>
		                <td class="p-2 flex items-center">
		                	<input type="text" id="nickname" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-400" minlength="1" maxlength="20" required>
		                	<div class="relative ml-4">
	                			<img id="profilePreview" th:src="@{/images/undraw_profile.svg}" class="w-14 h-12 rounded-full border" alt="í”„ë¡œí•„ ì´ë¯¸ì§€">
		                		<label for="profileImageInput" class="cursor-pointer">
		                			<span class="absolute bottom-0 left-1/2 transform -translate-x-1/2 translate-y-1/2 bg-gray-300 text-white text-[10px] rounded-full w-4 h-4 flex items-center justify-center opacity-50">â•</span>
		                		</label>
		                		<input type="file" id="profileImageInput" class="hidden" accept="image/png, image/jpeg, image/svg+xml">
		                	</div>
		                </td>
		            </tr>
		            
		            <tr>
		            	<td colspan="2"></td>
		            </tr>
		            <tr>
		            	<td colspan="2" class="font-medium p-2">ì¢‹ì•„í•˜ëŠ” ê²ƒì„ ê³ ë¥´ì„¸ìš”.</td>
		            </tr>
		
		            <!-- ë³´ì•ˆ ì§ˆë¬¸: ë¬´ì§€ê°œ ìƒ‰ê¹” -->
		            <tr>
		                <td class="font-medium p-2">ë¬´ì§€ê°œ ìƒ‰ê¹”</td>
		                <td class="p-2">
		                    <select id="myRainbow" name="color" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-400" required>
		                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
		                        <option value="ë¹¨ê°•">ğŸ”´ (ë¹¨ê°•)</option>
		                        <option value="ì£¼í™©">ğŸŸ  (ì£¼í™©)</option>
		                        <option value="ë…¸ë‘">ğŸŸ¡ (ë…¸ë‘)</option>
		                        <option value="ì´ˆë¡">ğŸŸ¢ (ì´ˆë¡)</option>
		                        <option value="íŒŒë‘">ğŸ”µ (íŒŒë‘)</option>
		                        <option value="ë‚¨ìƒ‰">ğŸ”µ+ğŸŸ£(ë‚¨ìƒ‰)</option>
		                        <option value="ë³´ë¼">ğŸŸ£ (ë³´ë¼)</option>
		                    </select>
		                </td>
		            </tr>
		
		            <!-- ë³´ì•ˆ ì§ˆë¬¸: ì¢‹ì•„í•˜ëŠ” ê³„ì ˆ -->
		            <tr>
		                <td class="font-medium p-2">ê³„ì ˆ</td>
		                <td class="p-2">
		                    <select id="mySeason" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-400" required>
		                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
		                        <option value="ì¶˜">ğŸŒ¸ ë´„</option>
		                        <option value="í•˜">ğŸ–ï¸ ì—¬ë¦„</option>
		                        <option value="ì¶”">ğŸ ê°€ì„</option>
		                        <option value="ë™">â˜ƒï¸ ê²¨ìš¸</option>
		                    </select>
		                </td>
		            </tr>
		
		            <!-- ë³´ì•ˆ ì§ˆë¬¸: ì¢‹ì•„í•˜ëŠ” ìˆ«ì -->
		            <tr>
		                <td class="font-medium p-2">ìˆ«ì (0~10)</td>
		                <td class="p-2">
		                    <select id="myNumber" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-400" required>
								<option value="">ì„ íƒí•˜ì„¸ìš”</option>
								<option value="0">0 ğŸŒ€</option>
								<option value="1">1 ğŸŒ±</option>
								<option value="2">2 ğŸ£</option>
								<option value="3">3 ğŸˆ</option>
								<option value="4">4 ğŸ€</option>
								<option value="5">5 ğŸŒŸ</option>
								<option value="6">6 ğŸŒŠ</option>
								<option value="7">7 ğŸµ</option>
								<option value="8">8 ğŸ§©</option>
								<option value="9">9 ğŸ”¥</option>
								<option value="10">10 ğŸ¯</option>
							</select>
		                </td>
		            </tr>
		        </tbody>
		    </table>
		    
            <div class="mt-6 transition-opacity duration-300" id="hiddenButtons">
	            <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600">ê°€ì…í•˜ê¸°</button>
	            <div class="flex justify-between mt-2 text-sm text-blue-500 cursor-pointer">
	                <a th:href="@{/User/FindUserPw.html}" class="hover:underline">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</a>
	                <a th:href="@{/User/Login.html}" class="hover:underline" >ë¡œê·¸ì¸</a>
	                <a th:href="@{/User/FindUserId.html}" class="hover:underline">ê³„ì • ì°¾ê¸°</a>
	            </div>
	        </div>
		</form>
    </div>

    <th:block layout:fragment="script">
    
    <script th:inline="javascript">
		document.getElementById("id").addEventListener("blur", async function() {
		    const idInput = this.value.trim(); // ì…ë ¥ëœ ID ê°’
		    const messageElement = document.getElementById("idCheckMessage");
		    
		    const idInputLen = idInput.length;
		    if( idInputLen < 1 ){
		    	messageElement.classList.add("hidden");
		    	return;
		    }
		    
		    messageElement.classList.remove("hidden");
		
		    // ID ê¸¸ì´ ê²€ì‚¬ (4~20ì)
		    if (idInputLen < 4 || idInputLen > 20) {
		        messageElement.textContent = "ì•„ì´ë””ëŠ” 4~20ì ì‚¬ì´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.";
		        messageElement.className = "text-red-500";
		        return;
		    }
		    
		    try {
		        // API ìš”ì²­ ë³´ë‚´ê¸°
		        const checkIdUri = /*[[@{/User/CheckId.json}]]*/ null;
		        const response = await fetch(`${checkIdUri}?id=${encodeURIComponent(idInput)}`);
		        const data = await response.json();
		
		        if (data.code === "0") {
		            messageElement.textContent = "ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤.";
		            messageElement.className = "text-green-500";
		        } else if (data.code === "E") {
		            messageElement.textContent = "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.";
		            messageElement.className = "text-red-500";
		        } else {
		            messageElement.textContent = "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
		            messageElement.className = "text-red-500";
		        }
		    } catch (error) {
		        console.error("ID ì²´í¬ ì˜¤ë¥˜:", error);
		        messageElement.textContent = "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
		        messageElement.className = "text-red-500";
		    }
		});
		
		function comparePassword(){
			const password = document.getElementById("password").value;
            const confirmPassword = document.getElementById("confirmPassword").value;
            const passwordError = document.getElementById("passwordError");
            const confirmPasswordError = document.getElementById("confirmPasswordError");
            
            // ë¹„ë°€ë²ˆí˜¸ ê²€ì‚¬ (ìˆ«ì, ì˜ë¬¸, íŠ¹ìˆ˜ë¬¸ì ì¤‘ 2ê°€ì§€ ì´ìƒ í¬í•¨)
            const hasNumber = /[0-9]/.test(password);
            const hasLetter = /[a-zA-Z]/.test(password);
            const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);
            const isValidPassword = (hasNumber && hasLetter) || (hasNumber && hasSpecial) || (hasLetter && hasSpecial);

            if (!isValidPassword || password.length < 6 || password.length > 20) {
                passwordError.classList.remove("hidden");
                return;
            } else {
                passwordError.classList.add("hidden");
            }

            if( password.length > 0 & confirmPassword.length > 0 ){
                // ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ê²€ì‚¬
                if (password !== confirmPassword) {
                    confirmPasswordError.classList.remove("hidden");
                } else {
                    confirmPasswordError.classList.add("hidden");
                }
            }
		}
		
		document.getElementById("password").addEventListener("blur", comparePassword);
		document.getElementById("confirmPassword").addEventListener("blur", comparePassword);
	</script>
	
	<script>
	// í”„ë¡œí•„ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥
    document.getElementById("profileImageInput").addEventListener("change", function(event) {
        const file = event.target.files[0];
        if (! file) {
        	return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
        	const fileType = file.type;
            
            if (fileType === "image/svg+xml") {
                // SVG ì²˜ë¦¬
                const img = new Image();
                img.onload = function() {
                	document.getElementById("profilePreview").src = convertSVGToPNG(img);
                };
                img.src = e.target.result;
            } else {
                // ì¼ë°˜ ì´ë¯¸ì§€ ì²˜ë¦¬ (PNG, JPG)
                const img = new Image();
                img.onload = function() {
                	document.getElementById("profilePreview").src = resizeImage(img);
                };
                img.src = e.target.result;
            }

        };
        reader.readAsDataURL(file);
        
    });
	
    function createCanvas(width, height) {
    	const canvas = document.createElement("canvas");
    	canvas.width = width;
    	canvas.height = height;
    	return canvas;
    }
    
    function convertSVGToPNG(img, maxSize = 100) {
    	console.info('convertSVGToPNG', img);
	    const canvas = createCanvas(maxSize, maxSize);
	    const ctx = canvas.getContext("2d");

	    const width = maxSize;
	    const height = maxSize;

	    canvas.width = width;
	    canvas.height = height;
	    ctx.drawImage(img, 0, 0, width, height);

	    return canvas.toDataURL("image/png");
	}

	function resizeImage(img, maxSize = 100) {
		console.info('resizeImage', img);
	    let width = img.width;
	    let height = img.height;

	    if (width > maxSize || height > maxSize) {
	        if (width > height) {
	            height *= maxSize / width;
	            width = maxSize;
	        } else {
	            width *= maxSize / height;
	            height = maxSize;
	        }
	    }

	    const canvas = createCanvas(maxSize, maxSize);
	    const ctx = canvas.getContext("2d");
	    canvas.width = width;
	    canvas.height = height;
	    ctx.drawImage(img, 0, 0, width, height);

	    return canvas.toDataURL("image/png");
	}
	</script>
    
    <script th:inline="javascript">
    
    async function getProfileImage() {
    	const profileImg = document.getElementById("profilePreview");
    	const imageFile = document.getElementById("profileImageInput").files[0];

    	if (!imageFile) {
    		console.info( 'ë¦¬ì‚¬ì´ì§• ì•ˆëœ ì›ë˜ ì´ë¯¸ì§€ ì²˜ë¦¬');
    		const img = new Image();
    		img.crossOrigin = "anonymous"; // í¬ë¡œìŠ¤ì˜¤ë¦¬ì§„ ë¬¸ì œ ë°©ì§€
    		img.src = profileImg.src;
    		
    		await new Promise((resolve) => {
    			img.onload = function() {
    				profileImg.src = convertSVGToPNG(img);
    				resolve(); // ì´ë¯¸ì§€ ë¡œë“œê°€ ì™„ë£Œë˜ë©´ ê³„ì† ì§„í–‰
    			};
    		});
    	}

    	try {
    		const imageUrl = profileImg.src;
    		let imageBlob;

    		if (imageUrl.startsWith("data:")) {
    			// Base64 ë°ì´í„°ë¥¼ Blobìœ¼ë¡œ ë³€í™˜
    			const byteCharacters = atob(imageUrl.split(",")[1]);
    			const byteNumbers = new Array(byteCharacters.length);
    			for (let i = 0; i < byteCharacters.length; i++) {
    				byteNumbers[i] = byteCharacters.charCodeAt(i);
    			}
    			const byteArray = new Uint8Array(byteNumbers);
    			imageBlob = new Blob([byteArray], { type: "image/png" });
    		} else {
    			// URLì—ì„œ ì§ì ‘ Blob ê°€ì ¸ì˜¤ê¸°
    			const response = await fetch(imageUrl);
    			imageBlob = await response.blob();
    		}

    		return new File([imageBlob], "default-profile.png", { type: imageBlob.type });
    	} catch (error) {
    		console.error("ê¸°ë³¸ ì´ë¯¸ì§€ ë³€í™˜ ì˜¤ë¥˜:", error);
    		return null;
    	}
    }
    
        document.getElementById("signupForm").addEventListener("submit", async function(event) {
            event.preventDefault();
            
        	saveUser();
        });
        
        async function saveUser() {
        	
        	const imageData = await getProfileImage();
        	if (!imageData) {
        		showCustomAlert("ì´ë¯¸ì§€ ì²˜ë¦¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        		return;
        	}
        	
            const formData = new FormData();
            formData.append("id", document.getElementById("id").value);
            formData.append("pw", encryptPassword( document.getElementById("password").value) );
            formData.append("birthday", document.getElementById("birthday").value);
            formData.append("nickname", document.getElementById("nickname").value);
            formData.append("myRainbow", document.getElementById("myRainbow").value);
            formData.append("mySeason", document.getElementById("mySeason").value);
            formData.append("myNumber", document.getElementById("myNumber").value);
            formData.append("token", /*[[${unique.token}]]*/ null);
            formData.append("rsaId", /*[[${unique.rsaId}]]*/ null);
            formData.append("image", imageData);

            try {
                const response = await fetch(/*[[@{/Auth/JoinUser.json}]]*/ null, {
                    method: "POST",
                    body: formData,
                    credentials: "include"
                });

                const result = await response.json();
                if (response.ok) {
                	showCustomAlert("íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", () => {
                		window.location.href = /*[[@{/User/Login.html}]]*/ null;
                	});
                } else {
                	showCustomAlert(result.message || "íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            } catch (error) {
                console.error("Error:", error);
                showCustomAlert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

    </script>
    </th:block>
</div>